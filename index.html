<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç¶ é‡å°‹è¹¤ Green Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; touch-action: manipulation; }
        .app-bg {background-image: url('Background.png'); background-size: cover;background-position: center;background-repeat: no-repeat; position: relative;overflow: hidden;}
        .main-content { z-index: 1; position: relative; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .modal-backdrop { transition: opacity 0.3s ease; opacity: 0; }
        .modal-backdrop.opacity-100 { opacity: 1; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        input[type="file"] { display: none; }
        .nav-item.active { color: #16a34a; }
        .achievement-unlocked { background-color: #d1fae5; border-color: #10b981; }
        .task-completed { text-decoration: line-through; color: #6b7280; }
        .pet-decoration { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 100px; height: auto; pointer-events: none; z-index: 10; }
        .pokedex-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; }
        .camera-view { object-fit: cover; width: 100%; height: 100%; }
        .pet-choice-card { border: 4px solid transparent; transition: border-color 0.2s ease-in-out; }
        .pet-choice-card.selected { border-color: #10b981; /* emerald-600 */ }
        .competition-timer { font-variant-numeric: tabular-nums; letter-spacing: 0.05em; }
        .competition-timer.warning { color: #ef4444; animation: timer-pulse 1s ease-in-out infinite; }
        @keyframes timer-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .progress-dot { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 700; transition: all 0.3s ease; }
        .progress-dot.current { background: #10b981; color: white; transform: scale(1.2); box-shadow: 0 0 0 3px rgba(16,185,129,0.3); }
        .progress-dot.correct { background: #10b981; color: white; }
        .progress-dot.incorrect { background: #ef4444; color: white; }
        .progress-dot.skipped { background: #9ca3af; color: white; }
        .progress-dot.pending { background: #e5e7eb; color: #9ca3af; }
        .podium-gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .podium-silver { background: linear-gradient(135deg, #d1d5db, #9ca3af); }
        .podium-bronze { background: linear-gradient(135deg, #d97706, #b45309); }
        .leaderboard-user-row { background-color: #ecfdf5; border: 2px solid #10b981; }
        @keyframes score-pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .score-animate { animation: score-pop 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-200 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto h-[800px] max-h-[90vh] bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col">

        <div id="screen-container" class="flex-grow relative">
            <div id="start-screen" class="hidden absolute inset-0 bg-emerald-50 p-8 flex flex-col justify-center items-center z-40">
                <h1 class="text-3xl font-bold text-emerald-700 mb-2">é¸æ“‡ä½ çš„å¤¥ä¼´</h1>
                <p class="text-gray-600 mb-6 text-center">é»æ“Šé¸æ“‡ä¸€å€‹å¤¥ä¼´ï¼Œä¸¦ç‚ºç‰ å–å€‹åå­—å§ï¼</p>
                
                <div class="flex gap-4 mb-6">
                    <div id="pet-choice-1" class="pet-choice-card rounded-2xl p-2 cursor-pointer bg-white shadow-md" data-visual="Pet1_1.png" data-name="ç¨®ç±½" data-type="seed1">
                        <img src="Pet1_1.png" class="w-24 h-24 object-contain rounded-xl">
                        <p class="text-center text-sm mt-1 font-semibold">ç¨®ç±½</p>
                    </div>
                    <div id="pet-choice-2" class="pet-choice-card rounded-2xl p-2 cursor-pointer bg-white shadow-md" data-visual="Pet2_1.png" data-name="è±†èŠ½" data-type="seed2">
                        <img src="Pet2_1.png" class="w-24 h-24 object-contain rounded-xl">
                         <p class="text-center text-sm mt-1 font-semibold">è±†èŠ½</p>
                    </div>
                </div>

                <input type="text" id="start-pet-name" placeholder="è¼¸å…¥å¯µç‰©åç¨±..." class="w-full p-3 border border-gray-300 rounded-lg mb-6 text-center focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                <button id="start-game-btn" class="btn w-full bg-emerald-500 text-white font-bold py-3 rounded-lg shadow-lg">é–‹å§‹éŠæˆ²</button>
            </div>

            <div id="home-screen" class="hidden w-full h-full flex flex-col app-bg">
                <header class="p-4 flex justify-between items-center z-10">
                    <div class="bg-white/70 backdrop-blur-sm rounded-full px-4 py-1 flex items-center shadow"><span id="level-text" class="font-bold text-emerald-700 mr-3">Lv.1</span><div class="w-24 bg-gray-300 rounded-full h-4"><div id="xp-bar" class="bg-gradient-to-r from-yellow-400 to-amber-500 h-4 rounded-full" style="width: 0%;"></div></div><span id="xp-value" class="text-xs font-bold text-gray-600 ml-2">0/10</span></div>
                    <div class="flex gap-2">
                        <button id="settings-btn" class="bg-white/70 backdrop-blur-sm rounded-full px-3 py-2 flex items-center shadow hover:bg-white/90 transition-colors"><span class="text-2xl">âš™ï¸</span></button>
                        <button id="achievements-btn" class="bg-white/70 backdrop-blur-sm rounded-full px-3 py-2 flex items-center shadow hover:bg-white/90 transition-colors"><span class="text-2xl">ğŸ†</span></button>
                        <div class="bg-white/70 backdrop-blur-sm rounded-full px-3 py-2 flex items-center shadow"><span class="text-2xl">ğŸŒ¿</span><span id="seed-count" class="font-bold text-emerald-700 ml-2">10</span></div>
                    </div>
                </header>
                <main class="flex-grow flex flex-col justify-end items-center main-content pb-4">
                    <div id="pet-display-area" class="relative text-center">
                        <img id="pet-decoration" class="pet-decoration hidden" src="" alt="å¯µç‰©è£é£¾">
                        <img id="pet-visual" src="" alt="é›»å­å¯µç‰©" class="h-64 w-auto drop-shadow-lg">
                        <p id="pet-name" class="mt-2 text-xl font-bold text-white" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.4)"></p>
                    </div>
                </main>
            </div>

            <div id="loading-screen" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col justify-center items-center z-30"><div class="animate-spin rounded-full h-16 w-16 border-b-4 border-emerald-500"></div><p class="mt-4 text-lg text-gray-600 font-semibold">AI æ­£åœ¨åŠªåŠ›è¾¨è­˜ä¸­...</p></div>
            <div id="result-screen" class="hidden absolute inset-0 bg-gray-50 flex flex-col p-4 sm:p-6 z-20 overflow-y-auto"></div>
            <div id="tasks-screen" class="hidden absolute inset-0 bg-gray-50 p-4 sm:p-6 z-20 overflow-y-auto"></div>
            <div id="achievements-screen" class="hidden absolute inset-0 bg-gray-50 p-4 sm:p-6 z-20 overflow-y-auto"></div>
            <div id="pokedex-screen" class="hidden absolute inset-0 bg-gray-50 p-4 sm:p-6 z-20 overflow-y-auto"></div>
            <div id="shop-screen" class="hidden absolute inset-0 bg-gray-50 p-4 sm:p-6 z-20 overflow-y-auto"></div>
            <div id="challenge-screen" class="hidden absolute inset-0 bg-gray-50 flex flex-col p-4 sm:p-6 z-20 overflow-y-auto"></div>
            <div id="competition-screen" class="hidden absolute inset-0 bg-gray-50 flex flex-col p-4 sm:p-6 z-20 overflow-y-auto"></div>
            <div id="competition-active-screen" class="hidden absolute inset-0 bg-gray-50 flex flex-col z-20 overflow-hidden"></div>
            <div id="competition-camera-screen" class="hidden absolute inset-0 bg-black flex flex-col justify-center items-center z-40">
                <video id="competition-camera-feed" class="camera-view" autoplay playsinline></video>
                <div class="absolute bottom-0 w-full p-4 flex justify-center items-center">
                    <button id="competition-capture-btn" class="w-20 h-20 bg-white rounded-full border-4 border-gray-400 focus:outline-none"></button>
                    <button id="competition-cancel-camera-btn" class="absolute right-4 text-white bg-black/30 rounded-full px-4 py-2">å–æ¶ˆ</button>
                </div>
            </div>

            <div id="camera-screen" class="hidden absolute inset-0 bg-black flex flex-col justify-center items-center z-40">
                <video id="camera-feed" class="camera-view" autoplay playsinline></video>
                <div class="absolute bottom-0 w-full p-4 flex justify-center items-center">
                    <button id="capture-btn" class="w-20 h-20 bg-white rounded-full border-4 border-gray-400 focus:outline-none"></button>
                    <button id="cancel-camera-btn" class="absolute right-4 text-white bg-black/30 rounded-full px-4 py-2">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <input type="file" id="plant-input" accept="image/*">
        <nav id="main-nav" class="hidden w-full bg-gray-100/90 backdrop-blur-sm grid grid-cols-6 gap-1 p-2 border-t border-gray-200 z-10">
            <button id="nav-home" class="nav-item flex flex-col items-center text-gray-600 p-1 rounded-lg active"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span class="text-xs font-medium">ä¸»é </span></button>
            <button id="nav-challenge" class="nav-item flex flex-col items-center text-gray-600 p-1 rounded-lg"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg><span class="text-xs font-medium">æŒ‘æˆ°</span></button>
            <button id="nav-competition" class="nav-item flex flex-col items-center text-gray-600 p-1 rounded-lg"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg><span class="text-xs font-medium">ç«¶è³½</span></button>
            <button id="nav-pokedex" class="nav-item flex flex-col items-center text-gray-600 p-1 rounded-lg"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg><span class="text-xs font-medium">åœ–é‘‘</span></button>
            <button id="nav-shop" class="nav-item flex flex-col items-center text-gray-600 p-1 rounded-lg"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg><span class="text-xs font-medium">å•†åº—</span></button>
            <button id="nav-tasks" class="nav-item flex flex-col items-center text-gray-600 p-1 rounded-lg"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg><span class="text-xs font-medium">ä»»å‹™</span></button>
        </nav>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl shadow-xl p-6 text-center max-w-sm mx-auto transform scale-95 opacity-0"></div>
    </div>
    <canvas id="canvas" class="hidden"></canvas>

<script>
    const GAME_DATA_KEY = 'greenQuestGameData';
    const WORKER_URL_KEY = 'greenQuestWorkerUrl';

    function getWorkerUrl() { return localStorage.getItem(WORKER_URL_KEY) || ''; }
    function setWorkerUrl(url) { localStorage.setItem(WORKER_URL_KEY, url); }

    const ALL_CHALLENGE_CATEGORIES = ['éç¶­ç®¡æ¤ç‰©', 'ç¶­ç®¡æ¤ç‰©', 'ç„¡ç¨®å­æ¤ç‰©', 'ç¨®å­æ¤ç‰©', 'ç„¡èŠ±æ¤ç‰©', 'æœ‰èŠ±æ¤ç‰©'];
    const COMPETITION_CATEGORIES = ['éç¶­ç®¡æ¤ç‰©', 'ç¶­ç®¡æ¤ç‰©', 'è£¸å­æ¤ç‰©', 'è•¨é¡æ¤ç‰©', 'å–®å­è‘‰æ¤ç‰©', 'é›™å­è‘‰æ¤ç‰©', 'æœ‰èŠ±æ¤ç‰©', 'ç„¡èŠ±æ¤ç‰©', 'ç„¡ç¨®å­æ¤ç‰©'];
    const COMPETITION_TIME_LIMIT_MS = 60 * 60 * 1000;

    function shuffleArray(arr) {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }

    const initialGameState = {
        gameStarted: false,
        level: 1, xp: 0, seeds: 100,
        pet: {
            type: 'seed1',
            stage: 1,
            name: 'å°ç¨®ç±½',
            visual: 'https://i.imgur.com/s79zW2c.png',
            evolutionPoints: { flower: 0, grass: 0, tree: 0 },
            decoration: null,
        },
        inventory: { specialFeed: 0, ownedDecorations: [] },
        pokedex: {},
        stats: { feeds: 0, correctAnswers: 0 },
        challenge: {
            currentMissions: shuffleArray(ALL_CHALLENGE_CATEGORIES),
            currentIndex: 0,
            cyclesCompleted: 0,
        },
        tasks: {
            dailyChallenge: { description: "æ¯æ—¥å®Œæˆä¸€æ¬¡æŒ‘æˆ°", reward: 20, completedToday: false, claimedToday: false, lastFeedDate: null },
            challengeNonVascular:  { description: "æŒ‘æˆ°ï¼šè¾¨è­˜éç¶­ç®¡æ¤ç‰©", reward: 15, requiredCategory: "éç¶­ç®¡æ¤ç‰©",  completedToday: false, claimedToday: false, lastFeedDate: null },
            challengeVascular:     { description: "æŒ‘æˆ°ï¼šè¾¨è­˜ç¶­ç®¡æ¤ç‰©",   reward: 15, requiredCategory: "ç¶­ç®¡æ¤ç‰©",    completedToday: false, claimedToday: false, lastFeedDate: null },
            challengeSeedless:     { description: "æŒ‘æˆ°ï¼šè¾¨è­˜ç„¡ç¨®å­æ¤ç‰©", reward: 15, requiredCategory: "ç„¡ç¨®å­æ¤ç‰©",  completedToday: false, claimedToday: false, lastFeedDate: null },
            challengeSeeded:       { description: "æŒ‘æˆ°ï¼šè¾¨è­˜ç¨®å­æ¤ç‰©",   reward: 15, requiredCategory: "ç¨®å­æ¤ç‰©",    completedToday: false, claimedToday: false, lastFeedDate: null },
            challengeNonFlowering: { description: "æŒ‘æˆ°ï¼šè¾¨è­˜ç„¡èŠ±æ¤ç‰©",   reward: 15, requiredCategory: "ç„¡èŠ±æ¤ç‰©",    completedToday: false, claimedToday: false, lastFeedDate: null },
            challengeFlowering:    { description: "æŒ‘æˆ°ï¼šè¾¨è­˜æœ‰èŠ±æ¤ç‰©",   reward: 15, requiredCategory: "æœ‰èŠ±æ¤ç‰©",    completedToday: false, claimedToday: false, lastFeedDate: null },
        },
        achievements: {
            firstAnswer: { name: "åˆç‚ºäººå¸«", description: "ç¬¬ä¸€æ¬¡æˆåŠŸå®ŒæˆæŒ‘æˆ°", target: 1, progress: 0, unlocked: false, metric: 'correctAnswers' },
            feedThreeTimes: { name: "å°å°è¾²å¤«", description: "ç´¯è¨ˆå®ŒæˆæŒ‘æˆ° 3 æ¬¡", target: 3, progress: 0, unlocked: false, metric: 'feeds' },
            reachLevelTwo: { name: "åˆçªºé–€å¾‘", description: "å¯µç‰©é”åˆ° 2 ç´š", target: 2, progress: 1, unlocked: false, metric: 'level' },
        },
        isProcessing: false, xpMultiplier: 1,
        competition: {
            monthlyScore: 0, monthlyCorrect: 0, monthlyWrong: 0,
            monthlyMonth: null, monthlyPlantsFound: [], session: null,
        },
    };
    
    const petEvolutionData = {
        seed1: {
            name: 'ç¨®ç±½',
            stages: {
                1: { visual: 'Pet1_1.png' },
                2: { visual: 'Pet1_2.png' },
                3: { visual: 'Pet1_3.png' }
            }
        },
        seed2: {
            name: 'è±†èŠ½',
            stages: {
                1: { visual: 'Pet2_1.png' },
                2: { visual: 'Pet2_2.png' },
                3: { visual: 'Pet2_3.png' }
            }
        }
    };
    const shopItems = [
        { id: 'special_feed', name: 'ç¥å¥‡ç‡Ÿé¤Šæ¶²', description: 'ä¸‹æ¬¡æŒ‘æˆ°ç¶“é©—å€¼åŠ å€ï¼', price: 50, icon: 'ğŸ§ª' },
        { id: 'hat_1', name: 'æ™‚å°šè‰å¸½', description: 'ç‚ºä½ çš„å¯µç‰©æ·»è³¼ä¸€é ‚å¯æ„›çš„è‰å¸½ã€‚', price: 150, icon: 'ğŸ‘’', visual: 'hat.png' },
    ];
    let gameState = {};
    let videoStream = null;
    let notificationQueue = [];
    let isShowingNotification = false;
    let competitionTimerInterval = null;
    let competitionIsProcessing = false;

    let navButtons, screens, petVisual, petName, levelText, xpBar, xpValue,
        seedCountText, plantInput, modal, petDecoration, 
        mainNav, cameraFeed, captureBtn, cancelCameraBtn, 
        canvas;

    const calculateXpToNextLevel = (level) => (2 * level);
    const getTodayString = () => new Date().toISOString().split('T')[0];

    function compressImageForStorage(dataUri, maxSize = 200, quality = 0.6) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                let w = img.width, h = img.height;
                if (w > h) { if (w > maxSize) { h = Math.round(h * maxSize / w); w = maxSize; } }
                else { if (h > maxSize) { w = Math.round(w * maxSize / h); h = maxSize; } }
                c.width = w; c.height = h;
                c.getContext('2d').drawImage(img, 0, 0, w, h);
                resolve(c.toDataURL('image/jpeg', quality));
            };
            img.onerror = () => resolve(dataUri);
            img.src = dataUri;
        });
    }

    function saveGameState() {
        try { localStorage.setItem(GAME_DATA_KEY, JSON.stringify(gameState)); } catch (e) { console.error("ç„¡æ³•å„²å­˜éŠæˆ²é€²åº¦:", e); }
    }

    function loadGameState() {
        try {
            const savedData = localStorage.getItem(GAME_DATA_KEY);
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                if (parsedData.gameStarted) {
                    gameState = parsedData;
                    
                    if (!gameState.pet.type) {
                        gameState.pet.type = 'seed1';
                    }
                    if (!gameState.pet.stage) {
                        gameState.pet.stage = 1;
                    }
                    
                    // Remove all old task keys
                    delete gameState.tasks.feedShrub;
                    delete gameState.tasks.feedTree;
                    delete gameState.tasks.feedHerbaceous;
                    delete gameState.tasks.feedVine;
                    delete gameState.tasks.dailyFeed;
                    delete gameState.tasks.feedNonVascular;
                    delete gameState.tasks.feedFern;
                    delete gameState.tasks.feedDicot;
                    delete gameState.tasks.feedMonocot;
                    delete gameState.tasks.feedGymnosperm;
                    delete gameState.currentQuiz;

                    // Add challenge state if missing
                    if (!gameState.challenge) {
                        gameState.challenge = {
                            currentMissions: shuffleArray(ALL_CHALLENGE_CATEGORIES),
                            currentIndex: 0,
                            cyclesCompleted: 0,
                        };
                    }

                    // Add new challenge tasks if missing
                    const defaultTasks = {
                        dailyChallenge:        { description: "æ¯æ—¥å®Œæˆä¸€æ¬¡æŒ‘æˆ°", reward: 20, completedToday: false, claimedToday: false, lastFeedDate: null },
                        challengeNonVascular:  { description: "æŒ‘æˆ°ï¼šè¾¨è­˜éç¶­ç®¡æ¤ç‰©", reward: 15, requiredCategory: "éç¶­ç®¡æ¤ç‰©",  completedToday: false, claimedToday: false, lastFeedDate: null },
                        challengeVascular:     { description: "æŒ‘æˆ°ï¼šè¾¨è­˜ç¶­ç®¡æ¤ç‰©",   reward: 15, requiredCategory: "ç¶­ç®¡æ¤ç‰©",    completedToday: false, claimedToday: false, lastFeedDate: null },
                        challengeSeedless:     { description: "æŒ‘æˆ°ï¼šè¾¨è­˜ç„¡ç¨®å­æ¤ç‰©", reward: 15, requiredCategory: "ç„¡ç¨®å­æ¤ç‰©",  completedToday: false, claimedToday: false, lastFeedDate: null },
                        challengeSeeded:       { description: "æŒ‘æˆ°ï¼šè¾¨è­˜ç¨®å­æ¤ç‰©",   reward: 15, requiredCategory: "ç¨®å­æ¤ç‰©",    completedToday: false, claimedToday: false, lastFeedDate: null },
                        challengeNonFlowering: { description: "æŒ‘æˆ°ï¼šè¾¨è­˜ç„¡èŠ±æ¤ç‰©",   reward: 15, requiredCategory: "ç„¡èŠ±æ¤ç‰©",    completedToday: false, claimedToday: false, lastFeedDate: null },
                        challengeFlowering:    { description: "æŒ‘æˆ°ï¼šè¾¨è­˜æœ‰èŠ±æ¤ç‰©",   reward: 15, requiredCategory: "æœ‰èŠ±æ¤ç‰©",    completedToday: false, claimedToday: false, lastFeedDate: null },
                    };
                    Object.entries(defaultTasks).forEach(([key, val]) => {
                        if (!gameState.tasks[key]) gameState.tasks[key] = val;
                    });
                    
                    // Add competition state if missing
                    if (!gameState.competition) {
                        gameState.competition = {
                            monthlyScore: 0, monthlyCorrect: 0, monthlyWrong: 0,
                            monthlyMonth: null, monthlyPlantsFound: [], session: null,
                        };
                    }
                    // Migrate old competition session format (had targetCategory instead of types)
                    if (gameState.competition.session && gameState.competition.session.targetCategory !== undefined) {
                        gameState.competition.session = null;
                    }

                    checkEvolution();

                    // Migrate oversized pokedex images (async, runs in background)
                    (async () => {
                        let migrated = false;
                        for (const plant of Object.values(gameState.pokedex)) {
                            if (plant.image && plant.image.length > 50000) {
                                plant.image = await compressImageForStorage(plant.image);
                                migrated = true;
                            }
                        }
                        if (migrated) saveGameState();
                    })();

                    return true;
                }
            }
            gameState = JSON.parse(JSON.stringify(initialGameState));
            return false;
        } catch (e) {
            console.error("ç„¡æ³•è®€å–éŠæˆ²é€²åº¦:", e);
            gameState = JSON.parse(JSON.stringify(initialGameState));
            return false;
        }
    }
    
    function queueNotification(contentHtml, onClose = () => {}) {
        notificationQueue.push({ contentHtml, onClose });
        if (!isShowingNotification) {
            showNextNotification();
        }
    }
    
    function showNextNotification() {
        if (notificationQueue.length === 0) {
            isShowingNotification = false;
            return;
        }
        
        isShowingNotification = true;
        const notification = notificationQueue.shift();
        showModal(notification.contentHtml, () => {
            notification.onClose();
            setTimeout(() => showNextNotification(), 100);
        });
    }
    
    function showModal(contentHtml, onClose = () => {}) {
        const modalContent = modal.querySelector('.modal-content');
        modalContent.innerHTML = contentHtml;
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.add('opacity-100');
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        
        const closeBtn = modalContent.querySelector('.modal-close-btn');
        if(closeBtn) {
            const closeHandler = () => {
                hideModal();
                onClose();
                closeBtn.removeEventListener('click', closeHandler);
            };
            closeBtn.addEventListener('click', closeHandler);
        }
    }
    
    function hideModal() {
        const modalContent = modal.querySelector('.modal-content');
        modal.classList.remove('opacity-100');
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function showSettingsModal() {
        const currentUrl = getWorkerUrl();
        showModal(`
            <div class="text-left">
                <h3 class="text-xl font-bold text-center text-emerald-700 mb-4">âš™ï¸ è¨­å®š</h3>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">API ä¼ºæœå™¨ç¶²å€</label>
                    <input type="url" id="settings-worker-url" value="${currentUrl}" placeholder="https://your-worker.workers.dev/" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                    <p class="text-xs text-gray-400 mt-1">Cloudflare Worker çš„å®Œæ•´ç¶²å€</p>
                </div>
                <div class="flex gap-3">
                    <button id="settings-save-btn" class="flex-1 bg-emerald-500 text-white font-bold py-2 px-4 rounded-full">å„²å­˜</button>
                    <button class="modal-close-btn flex-1 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full">å–æ¶ˆ</button>
                </div>
            </div>
        `);
        document.getElementById('settings-save-btn').addEventListener('click', () => {
            const newUrl = document.getElementById('settings-worker-url').value.trim();
            setWorkerUrl(newUrl);
            hideModal();
            showModal('<div class="text-6xl mb-4">âœ…</div><h3 class="text-2xl font-bold mb-2">å·²å„²å­˜</h3><p class="text-gray-600 mb-6">API ä¼ºæœå™¨ç¶²å€å·²æ›´æ–°ã€‚</p><button class="modal-close-btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">ç¢ºå®š</button>');
        });
    }

    function navigateTo(screenName) {
        if ((screenName === 'challenge' || screenName === 'competition') && !getWorkerUrl()) {
            showModal('<div class="text-6xl mb-4">âš ï¸</div><h3 class="text-2xl font-bold mb-2">å°šæœªè¨­å®š API ç¶²å€</h3><p class="text-gray-600 mb-6">è«‹å…ˆåˆ°ä¸»é é»æ“Š âš™ï¸ è¨­å®š API ä¼ºæœå™¨ç¶²å€ï¼Œæ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚</p><button class="modal-close-btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">äº†è§£</button>');
            return;
        }
        // Guard: confirm before leaving active competition
        if (gameState.competition && gameState.competition.session
            && Date.now() < gameState.competition.session.endTime
            && screenName !== 'competition' && screenName !== 'competitionActive' && screenName !== 'competitionCamera') {
            showModal(
                '<div class="text-6xl mb-4">âš ï¸</div>'
                + '<h3 class="text-2xl font-bold mb-2">ç«¶è³½é€²è¡Œä¸­</h3>'
                + '<p class="text-gray-600 mb-6">é›¢é–‹å°‡çµæŸç›®å‰çš„ç«¶è³½ã€‚ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ</p>'
                + '<div class="flex gap-3">'
                + '<button id="competition-leave-confirm" class="flex-1 bg-red-500 text-white font-bold py-2 px-4 rounded-full">é›¢é–‹</button>'
                + '<button class="modal-close-btn flex-1 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full">å–æ¶ˆ</button>'
                + '</div>'
            );
            document.getElementById('competition-leave-confirm').addEventListener('click', () => {
                hideModal();
                endCompetitionSession(true);
                setTimeout(() => navigateTo(screenName), 400);
            });
            return;
        }
        Object.values(screens).forEach(s => s && s.classList.add('hidden'));
        if (screens[screenName]) screens[screenName].classList.remove('hidden');
        Object.values(navButtons).forEach(b => b && b.classList.remove('active'));
        if (navButtons[screenName]) navButtons[screenName].classList.add('active');
        if (screenName === 'tasks') renderTasks();
        if (screenName === 'pokedex') renderPokedex();
        if (screenName === 'shop') renderShop();
        if (screenName === 'challenge') renderChallengeScreen();
        if (screenName === 'competition') renderCompetitionLobby();
    }

    function renderAll() { renderUI(); renderPet(); }
    
    function renderUI() {
        const { level, xp, seeds } = gameState;
        const xpToNextLevel = calculateXpToNextLevel(level);
        levelText.textContent = `Lv.${level}`;
        seedCountText.textContent = seeds;
        xpValue.textContent = `${xp}/${xpToNextLevel}`;
        xpBar.style.width = `${Math.min((xp / xpToNextLevel) * 100, 100)}%`;
    }

    function renderPet() {
        const { pet } = gameState;
        petVisual.src = pet.visual;
        petName.textContent = pet.name;
        if (pet.decoration) {
            petDecoration.src = pet.decoration;
            petDecoration.classList.remove('hidden');
        } else {
            petDecoration.classList.add('hidden');
        }
    }

    function renderTasks() {
        const container = screens.tasks;
        if (!container.querySelector('h2')) {
             container.innerHTML = `<h2 class="text-xl sm:text-2xl font-bold text-center text-emerald-700 mb-6">ä»»å‹™ä¸­å¿ƒ</h2><div id="tasks-list" class="space-y-3"></div>`;
        }
        const list = container.querySelector('#tasks-list');
        list.innerHTML = '';
        
        shuffleArray(Object.entries(gameState.tasks)).forEach(([taskKey, task]) => {
            const taskEl = document.createElement('div');
            let buttonHtml;
            if (task.claimedToday) {
                buttonHtml = `<button class="btn px-4 py-2 rounded-full text-white bg-gray-400" disabled>å·²é ˜å–</button>`;
            } else if (task.completedToday) {
                buttonHtml = `<button class="claim-task-btn btn px-4 py-2 rounded-full text-white bg-green-500 hover:bg-green-600" data-task="${taskKey}">é ˜å–</button>`;
            } else {
                buttonHtml = `<button class="btn px-4 py-2 rounded-full text-white bg-gray-400" disabled>æœªå®Œæˆ</button>`;
            }
            taskEl.className = `p-4 border rounded-lg shadow-sm ${task.claimedToday ? 'bg-gray-200' : 'bg-white'}`;
            taskEl.innerHTML = `<div class="flex justify-between items-center"><div><p class="font-bold ${task.claimedToday ? 'task-completed' : ''}">${task.description}</p><p class="text-sm text-green-600">çå‹µ: ${task.reward} ğŸŒ¿</p></div>${buttonHtml}</div>`;
            list.appendChild(taskEl);
        });
        
        document.querySelectorAll('.claim-task-btn').forEach(btn => {
            btn.addEventListener('click', (e) => claimTaskReward(e.target.dataset.task));
        });
    }
    
    function claimTaskReward(taskKey) {
        const task = gameState.tasks[taskKey];
        if (task && task.completedToday && !task.claimedToday) {
            task.claimedToday = true;
            gameState.seeds += task.reward;
            showModal(`<div class="text-6xl mb-4">ğŸ‰</div><h3 class="text-2xl font-bold mb-2">çå‹µå·²é ˜å–ï¼</h3><p class="text-gray-600 mb-6">ç²å¾— <b>${task.reward}</b> ğŸŒ¿ï¼</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">ç¹¼çºŒ</button>`, () => {
                renderAll();
                renderTasks();
                saveGameState();
            });
        }
    }

    function renderAchievements() {
        const container = screens.achievements;
        if (!container.querySelector('h2')) {
            container.innerHTML = `<h2 class="text-xl sm:text-2xl font-bold text-center text-emerald-700 mb-6">æˆ‘çš„æˆå°±</h2><div id="achievements-list" class="space-y-3"></div>`;
        }
        const list = container.querySelector('#achievements-list');
        list.innerHTML = '';
        Object.values(gameState.achievements).forEach(ach => {
            const progress = Math.min(ach.progress, ach.target);
            const percentage = Math.floor((progress / ach.target) * 100);
            const achEl = document.createElement('div');
            achEl.className = `p-4 border rounded-lg shadow-sm ${ach.unlocked ? 'achievement-unlocked' : 'bg-white'}`;
            achEl.innerHTML = `<div class="flex items-center"><div class="text-4xl mr-4">${ach.unlocked ? 'ğŸ†' : 'â³'}</div><div><p class="font-bold">${ach.name}</p><p class="text-sm text-gray-600">${ach.description}</p><div class="w-full bg-gray-200 rounded-full h-2.5 mt-2"><div class="bg-yellow-400 h-2.5 rounded-full" style="width: ${percentage}%"></div></div><p class="text-xs text-right text-gray-500 mt-1">${progress} / ${ach.target}</p></div></div>`;
            list.appendChild(achEl);
        });
    }

    function renderPokedex() {
        const container = screens.pokedex;
        if (!container.querySelector('h2')) {
            container.innerHTML = `<h2 class="text-xl sm:text-2xl font-bold text-center text-emerald-700 mb-6">æ¤ç‰©åœ–é‘‘</h2><div id="pokedex-grid" class="pokedex-grid"></div>`;
        }
        const grid = container.querySelector('#pokedex-grid');
        grid.innerHTML = '';
        if (Object.keys(gameState.pokedex).length === 0) {
            grid.innerHTML = '<p class="col-span-full text-center text-gray-500">é‚„æ²’æœ‰æ”¶é›†åˆ°ä»»ä½•æ¤ç‰©ï¼Œå¿«å»å®ŒæˆæŒ‘æˆ°å§ï¼</p>';
            return;
        }
        for (const plant of Object.values(gameState.pokedex)) {
            const card = document.createElement('div');
            card.className = 'pokedex-card bg-white rounded-lg shadow p-2 text-center cursor-pointer hover:shadow-lg transition-shadow';
            card.innerHTML = `<img src="${plant.image}" alt="${plant.name}" class="w-full h-20 object-cover rounded-md mb-2"><p class="text-sm font-bold truncate">${plant.name}</p><p class="text-xs text-gray-500">${plant.type}</p>`;
            card.addEventListener('click', () => showPlantDetail(plant));
            grid.appendChild(card);
        }
    }
    
async function showPlantDetail(plant) {
        const loadingContent = `<div class="text-6xl mb-4">ğŸŒ¿</div><h3 class="text-2xl font-bold mb-2">${plant.name}</h3><p class="text-sm text-gray-500 italic mb-4">${plant.scientificName || ''}</p><div class="animate-spin rounded-full h-12 w-12 border-b-4 border-emerald-500 mx-auto mb-4"></div><p class="text-gray-600">AI æ­£åœ¨ç”Ÿæˆè©³ç´°è³‡è¨Š...</p>`;
        showModal(loadingContent);
        
        const prompt = `è«‹ç‚ºä»¥ä¸‹æ¤ç‰©ç”Ÿæˆè©³ç´°ä»‹ç´¹ï¼Œåš´æ ¼æŒ‰ç…§JSONæ ¼å¼å›å‚³ï¼š
        æ¤ç‰©åç¨±ï¼š${plant.name}
        ${plant.scientificName ? `å­¸åï¼š${plant.scientificName}` : ''}
        æ¤ç‰©é¡å‹ï¼š${plant.type}
        
        è«‹æä¾›ä»¥ä¸‹è³‡è¨Šï¼š
        { "flowerLanguage": "è©²æ¤ç‰©çš„èŠ±èªï¼ˆå¦‚æœæœ‰çš„è©±ï¼Œæ²’æœ‰å‰‡å›å‚³ç©ºå­—ä¸²ï¼‰", "bloomingSeason": "è©²æ¤ç‰©çš„èŠ±æœŸæˆ–ç”Ÿé•·å­£ç¯€", "description": "ç°¡çŸ­æè¿°è©²æ¤ç‰©çš„ç‰¹å¾µã€ç”Ÿé•·ç’°å¢ƒã€ç”¨é€”ç­‰ï¼ˆç´„50-80å­—ï¼‰" }`;
        
        // --- ä¿®æ”¹éƒ¨åˆ†é–‹å§‹ ---
        // é€™è£¡ä¸å†éœ€è¦ API Keyï¼Œç›´æ¥ç™¼é€è«‹æ±‚çµ¦ Cloudflare Worker
        const payload = { 
            contents: [{ role: "user", parts: [{ text: prompt }] }], 
            generationConfig: { responseMimeType: "application/json" } 
        };
        
        try {
            const workerUrl = getWorkerUrl();
            if (!workerUrl) {
                showModal('<div class="text-6xl mb-4">âš ï¸</div><h3 class="text-2xl font-bold mb-2">å°šæœªè¨­å®š API ç¶²å€</h3><p class="text-gray-600 mb-6">è«‹å…ˆåˆ°ä¸»é é»æ“Š âš™ï¸ è¨­å®š API ä¼ºæœå™¨ç¶²å€ã€‚</p><button class="modal-close-btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">äº†è§£</button>');
                return;
            }
            const response = await fetch(workerUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload) 
            });
            // --- ä¿®æ”¹éƒ¨åˆ†çµæŸ ---

            if (!response.ok) throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status}`);
            const result = await response.json();
            const detailData = JSON.parse(result.candidates[0].content.parts[0].text);
            
            const flowerLanguageHtml = detailData.flowerLanguage ? `<div class="mb-3"><p class="text-sm font-semibold text-emerald-700">èŠ±èª</p><p class="text-sm text-gray-700">${detailData.flowerLanguage}</p></div>` : '';
            const scientificNameHtml = plant.scientificName ? `<p class="text-sm text-gray-500 italic mb-4">${plant.scientificName}</p>` : '';
            
            const herbariumUrl = 'https://www.herbarium.gov.hk/tc/hk-plant-database/index.html';
            const content = `
                <div class="text-left max-h-[70vh] overflow-y-auto">
                    <img src="${plant.image}" alt="${plant.name}" class="w-full max-h-48 object-cover rounded-lg mb-4">
                    <h3 class="text-2xl font-bold mb-2 text-center">${plant.name}</h3>
                    ${scientificNameHtml}
                    <div class="mb-3">
                        <p class="text-sm font-semibold text-emerald-700">æ¤ç‰©ç¨®é¡</p>
                        <p class="text-sm text-gray-700">${plant.type}</p>
                    </div>
                    ${flowerLanguageHtml}
                    <div class="mb-3">
                        <p class="text-sm font-semibold text-emerald-700">èŠ±æœŸ / ç”Ÿé•·å­£ç¯€</p>
                        <p class="text-sm text-gray-700">${detailData.bloomingSeason}</p>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm font-semibold text-emerald-700">ç°¡ä»‹</p>
                        <p class="text-sm text-gray-700">${detailData.description}</p>
                    </div>
                    <div class="bg-emerald-50 p-3 rounded-lg mb-4">
                        <p class="text-xs font-semibold text-emerald-700 mb-1">å°çŸ¥è­˜</p>
                        <p class="text-xs text-gray-600">${plant.fact}</p>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg mb-4">
                        <p class="text-xs font-semibold text-blue-700 mb-2">ğŸ›ï¸ å®˜æ–¹æ¤ç‰©è³‡æ–™åº«</p>
                        <p class="text-xs text-gray-600 mb-2">æƒ³äº†è§£æ›´å¤šæ¬Šå¨è³‡è¨Šï¼Ÿå¯å‰å¾€é¦™æ¸¯æ¤ç‰©æ¨™æœ¬å®¤æŸ¥è©¢æ­¤æ¤ç‰©çš„å®˜æ–¹è¨˜éŒ„ã€‚</p>
                        <a href="${herbariumUrl}" target="_blank" rel="noopener noreferrer" class="text-xs text-blue-600 hover:text-blue-800 underline">ğŸ”— å‰å¾€é¦™æ¸¯æ¤ç‰©æ¨™æœ¬å®¤</a>
                    </div>
                    <button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full w-full">é—œé–‰</button>
                </div>
            `;
            showModal(content);
        } catch (error) {
            console.error("å–å¾—æ¤ç‰©è©³ç´°è³‡è¨Šå¤±æ•—:", error);
            showModal(`<div class="text-6xl mb-4">ğŸ˜¢</div><h3 class="text-2xl font-bold mb-2">ç„¡æ³•è¼‰å…¥è©³ç´°è³‡è¨Š</h3><p class="text-gray-600 mb-6">è«‹ç¨å¾Œå†è©¦ã€‚</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">é—œé–‰</button>`);
        }
    }

    function renderShop() {
        const container = screens.shop;
        if (!container.querySelector('h2')) {
            container.innerHTML = `<h2 class="text-xl sm:text-2xl font-bold text-center text-emerald-700 mb-6">å•†åº—</h2><div id="shop-items-list" class="space-y-4"></div>`;
        }
        const list = container.querySelector('#shop-items-list');
        list.innerHTML = '';
        shopItems.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = 'flex items-center justify-between bg-white p-3 rounded-lg shadow-sm';
            const owned = gameState.inventory.ownedDecorations.includes(item.id);
            itemEl.innerHTML = `<div class="flex items-center"><div class="text-4xl mr-4">${item.icon}</div><div><p class="font-bold">${item.name}</p><p class="text-sm text-gray-600">${item.description}</p></div></div><button class="btn buy-btn" data-item-id="${item.id}" ${owned ? 'disabled' : ''}>${owned ? 'å·²æ“æœ‰' : `ğŸŒ¿ ${item.price}`}</button>`;
            list.appendChild(itemEl);
        });
        document.querySelectorAll('.buy-btn').forEach(btn => btn.addEventListener('click', handleBuyItem));
    }
    
    function handleBuyItem(event) {
        const itemId = event.target.dataset.itemId;
        const item = shopItems.find(i => i.id === itemId);
        if (!item || gameState.seeds < item.price) {
            showModal(`<div class="text-6xl mb-4">ğŸ˜•</div><h3 class="text-2xl font-bold mb-2">è³¼è²·å¤±æ•—</h3><p class="text-gray-600 mb-6">æ‚¨çš„ ğŸŒ¿ ä¸è¶³ï¼</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">å¥½çš„</button>`);
            return;
        }
        gameState.seeds -= item.price;
        if (item.id.includes('feed')) {
            gameState.inventory.specialFeed++;
            showModal(`<div class="text-6xl mb-4">ğŸ‰</div><h3 class="text-2xl font-bold mb-2">è³¼è²·æˆåŠŸï¼</h3><p class="text-gray-600 mb-6">æ‚¨è³¼è²·äº† ${item.name}ï¼</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">ç¹¼çºŒ</button>`);
        } else if (item.id.includes('hat')) {
            gameState.inventory.ownedDecorations.push(item.id);
            gameState.pet.decoration = item.visual;
            showModal(`<div class="text-6xl mb-4">ğŸ‰</div><h3 class="text-2xl font-bold mb-2">è³¼è²·æˆåŠŸï¼</h3><p class="text-gray-600 mb-6">æ‚¨è³¼è²·äº† ${item.name}ï¼Œå·²ç‚ºå¯µç‰©æˆ´ä¸Šï¼</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">å¥½çš„</button>`);
        }
        renderAll();
        renderShop();
        saveGameState();
    }

    async function startCamera() {
        try {
            const constraints = { video: { facingMode: 'environment' } };
            videoStream = await navigator.mediaDevices.getUserMedia(constraints);
            cameraFeed.srcObject = videoStream;
            navigateTo('camera');
        } catch(err) {
            console.warn("å¾Œç½®é¡é ­é–‹å•Ÿå¤±æ•—ï¼Œå˜—è©¦é è¨­é¡é ­: ", err);
            try {
                const constraints = { video: true };
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = videoStream;
                navigateTo('camera');
            } catch (finalErr) {
                console.error("ç„¡æ³•é–‹å•Ÿä»»ä½•ç›¸æ©Ÿ: ", finalErr);
                showModal(`<div class="text-6xl mb-4">ğŸ˜Ÿ</div><h3 class="text-2xl font-bold mb-2">ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ</h3><p class="text-gray-600 mb-6">è«‹ç¢ºèªæ‚¨å·²æˆæ¬Šç€è¦½å™¨ä½¿ç”¨ç›¸æ©Ÿï¼Œæˆ–æ‚¨çš„è£ç½®æœ‰å¯ç”¨çš„é¡é ­ã€‚</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">äº†è§£</button>`);
            }
        }
    }
    function stopCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
    }
    function capturePhoto() {
        canvas.width = cameraFeed.videoWidth;
        canvas.height = cameraFeed.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
        
        const dataUri = canvas.toDataURL('image/png');
        const base64Data = dataUri.split(',')[1];
        
        stopCamera();
        processImage(base64Data, dataUri);
    }
    
    function getChallengeData() {
        const hints = {
            'éç¶­ç®¡æ¤ç‰©': 'éç¶­ç®¡æ¤ç‰©æ²’æœ‰å°æ°´çš„ç¶­ç®¡æŸçµ„ç¹”ã€‚è©¦è©¦æ‰¾æ‰¾è‹”è˜šï¼ˆMossesï¼‰ã€åœ°éŒ¢ï¼ˆLiverwortsï¼‰æˆ–è—»é¡ï¼ˆAlgaeï¼‰â€”â€”å®ƒå€‘é€šå¸¸ç”Ÿé•·åœ¨æ½®æ¿•çš„çŸ³é ­ã€æ¨¹å¹¹æˆ–æ°´ä¸­ã€‚',
            'ç¶­ç®¡æ¤ç‰©':   'ç¶­ç®¡æ¤ç‰©æ“æœ‰é‹è¼¸æ°´åˆ†å’Œé¤Šåˆ†çš„ç¶­ç®¡æŸã€‚è•¨é¡ã€é–‹èŠ±æ¤ç‰©å’Œæ¾æ¨¹éƒ½å±¬æ–¼ç¶­ç®¡æ¤ç‰©ï¼Œä½†è‹”è˜šä¸ç®—ã€‚è©¦è©¦æ‰¾ä¸€ç¨®æœ‰è‘‰æœ‰è–çš„æ¤ç‰©ã€‚',
            'ç„¡ç¨®å­æ¤ç‰©': 'ç„¡ç¨®å­æ¤ç‰©é å­¢å­ç¹æ®–ï¼Œè€Œéç¨®å­ã€‚è•¨é¡ï¼ˆFernsï¼‰å°±æ˜¯æœ€å¥½çš„ä¾‹å­â€”â€”æ³¨æ„è‘‰èƒŒé¢çš„å­¢å­å›Šï¼Œæˆ–åœ¨æ—è”­æ¿•åœ°å°‹æ‰¾è•¨é¡æ¤ç‰©ã€‚',
            'ç¨®å­æ¤ç‰©':   'ç¨®å­æ¤ç‰©ç”¨ç¨®å­ç¹æ®–ã€‚é–‹èŠ±æ¤ç‰©å’Œæ¾æ¨¹ã€æ‰æ¨¹éƒ½æ˜¯ç¨®å­æ¤ç‰©ã€‚è©¦è©¦æ‰¾ä¸€æ£µçµæœæˆ–æœ‰æ¯¬æœçš„æ¨¹æœ¨ï¼Œæˆ–ä»»ä½•é–‹èŠ±çš„æ¤ç‰©ã€‚',
            'ç„¡èŠ±æ¤ç‰©':   'ç„¡èŠ±æ¤ç‰©ï¼ˆè£¸å­æ¤ç‰©ï¼‰ç”¨æ¯¬æœè€ŒéèŠ±æœµç¹æ®–ã€‚è©¦è©¦æ‰¾æ¾æ¨¹ï¼ˆPineï¼‰ã€æ‰æ¨¹ï¼ˆCypressï¼‰ã€éŠ€æï¼ˆGinkgoï¼‰æˆ–è˜‡éµï¼ˆCycadï¼‰â€”â€”å®ƒå€‘çš„ç¨®å­æ˜¯ã€Œè£¸éœ²ã€çš„ï¼Œæ²’æœ‰æœå¯¦åŒ…è£¹ã€‚',
            'æœ‰èŠ±æ¤ç‰©':   'æœ‰èŠ±æ¤ç‰©ï¼ˆè¢«å­æ¤ç‰©ï¼‰æ˜¯æœ€å¤šæ¨£çš„æ¤ç‰©é¡ç¾¤ã€‚ç„¡è«–æ˜¯ç«ç‘°ã€è˜­èŠ±ã€å‘æ—¥è‘µé‚„æ˜¯ç¦¾è‰ï¼Œåªè¦æœƒé–‹èŠ±å°±ç®—ã€‚è©¦è©¦åœ¨èŠ±åœƒæˆ–è·¯é‚Šæ‰¾ä»»ä½•ä¸€ç¨®é–‹èŠ±çš„æ¤ç‰©ã€‚',
            'è£¸å­æ¤ç‰©':   'è£¸å­æ¤ç‰©çš„ç¨®å­è£¸éœ²åœ¨å¤–ï¼Œæ²’æœ‰æœå¯¦åŒ…è£¹ã€‚æ¾æ¨¹ï¼ˆPineï¼‰ã€æ‰æ¨¹ï¼ˆCypressï¼‰ã€éŠ€æï¼ˆGinkgoï¼‰å’Œè˜‡éµï¼ˆCycadï¼‰éƒ½æ˜¯è£¸å­æ¤ç‰©â€”â€”å°‹æ‰¾æœ‰æ¯¬æœçš„æ¨¹æœ¨ã€‚',
            'è•¨é¡æ¤ç‰©':   'è•¨é¡æ¤ç‰©æ²’æœ‰ç¨®å­ï¼Œé å­¢å­ç¹æ®–ã€‚æ³¨æ„å®ƒå€‘ç‰¹å¾µæ€§çš„ç¾½ç‹€è¤‡è‘‰ï¼Œç¿»éä¾†çœ‹è‘‰èƒŒå¯èƒ½æœ‰æ£•è‰²å­¢å­å›Šç¾¤ã€‚åœ¨æ½®æ¿•é™°æš—çš„æ—ä¸‹æˆ–æºªé‚Šæœ€å®¹æ˜“æ‰¾åˆ°ã€‚',
            'å–®å­è‘‰æ¤ç‰©': 'å–®å­è‘‰æ¤ç‰©çš„ç‰¹å¾µæ˜¯å¹³è¡Œè„ˆè‘‰ç‰‡ã€èŠ±ç“£å¤šç‚º3çš„å€æ•¸ã€‚ç¦¾è‰ã€ç«¹å­ã€ç™¾åˆã€è˜­èŠ±ã€æ£•æ«šã€é¦™è•‰éƒ½æ˜¯å–®å­è‘‰æ¤ç‰©ã€‚',
            'é›™å­è‘‰æ¤ç‰©': 'é›™å­è‘‰æ¤ç‰©è‘‰ç‰‡é€šå¸¸æœ‰ç¶²ç‹€è„ˆï¼ŒèŠ±ç“£å¤šç‚º4æˆ–5çš„å€æ•¸ã€‚ç«ç‘°ã€å‘æ—¥è‘µã€è±†ç§‘æ¤ç‰©ã€å¤§éƒ¨åˆ†çš„æ¨¹æœ¨ï¼ˆæ¥“ã€æ¦•ã€æœ¨æ£‰ï¼‰éƒ½æ˜¯é›™å­è‘‰æ¤ç‰©ã€‚',
        };
        const extras = {
            'éç¶­ç®¡æ¤ç‰©': 'ä½ æ‰¾åˆ°äº†éç¶­ç®¡æ¤ç‰©ï¼å®ƒå€‘æ˜¯æœ€å¤è€çš„é™¸ç”Ÿæ¤ç‰©ä¹‹ä¸€ï¼Œåœ¨ç´„4å„„7åƒè¬å¹´å‰ç‡å…ˆç™»ä¸Šé™¸åœ°ã€‚è‹”è˜šæ²’æœ‰æ ¹ï¼Œé æ•´å€‹è‘‰ç‹€é«”å¸æ”¶æ°´åˆ†ï¼Œå› æ­¤ç‰¹åˆ¥ä¾è³´æ½®æ¿•ç’°å¢ƒâ€”â€”å®ƒå€‘ä¹Ÿæ˜¯æ¿•åœ°ç”Ÿæ…‹ç³»çš„é‡è¦æŒ‡ç¤ºç‰©ç¨®ã€‚',
            'ç¶­ç®¡æ¤ç‰©':   'ç¶­ç®¡æ¤ç‰©çš„å‡ºç¾æ˜¯æ¤ç‰©æ¼”åŒ–å²ä¸Šçš„é‡å¤§çªç ´ï¼ç¶­ç®¡æŸç³»çµ±ï¼ˆæœ¨è³ªéƒ¨å’ŒéŸŒçš®éƒ¨ï¼‰è®“æ¤ç‰©å¾—ä»¥é•·é«˜ï¼Œå½¢æˆä»Šæ—¥çš„æ£®æ—ã€‚åœ°çƒä¸Šè¶…é90%çš„æ¤ç‰©ç¨®é¡éƒ½æ˜¯ç¶­ç®¡æ¤ç‰©ã€‚',
            'ç„¡ç¨®å­æ¤ç‰©': 'è•¨é¡æ¤ç‰©åœ¨3å„„å¤šå¹´å‰çš„çŸ³ç‚­ç´€æ›¾æ˜¯åœ°çƒçš„ä¸»å®°ï¼é‚£æ™‚çš„è•¨é¡å¯é«˜é”30å…¬å°ºï¼Œå½¢æˆé¾å¤§çš„ã€Œè•¨é¡æ£®æ—ã€ã€‚ä»Šå¤©æˆ‘å€‘ç‡ƒç‡’çš„ç…¤ç‚­ï¼Œå¤§éƒ¨åˆ†æ­£æ˜¯ç”±é‚£å€‹æ™‚ä»£çš„è•¨é¡åŒ–çŸ³å½¢æˆçš„ã€‚',
            'ç¨®å­æ¤ç‰©':   'ç¨®å­æ˜¯æ¤ç‰©çš„å‰å¤§ç™¼æ˜â€”â€”å®ƒç‚ºèƒšèƒæä¾›é¤Šåˆ†å’Œä¿è­·ï¼Œè®“æ¤ç‰©å¾—ä»¥åœ¨ä¹¾ç‡¥ç’°å¢ƒä¸­ç¹æ®–ã€‚æ­£å› å¦‚æ­¤ï¼Œç¨®å­æ¤ç‰©åœ¨å¤§ç´„3å„„å¹´å‰é–‹å§‹ä¸»å°é™¸åœ°ç”Ÿæ…‹ç³»ï¼Œä¸¦æ¼”åŒ–å‡ºæˆ‘å€‘ä»Šæ—¥çœ‹åˆ°çš„ç¹èŒ‚å¤šæ¨£ã€‚',
            'ç„¡èŠ±æ¤ç‰©':   'è£¸å­æ¤ç‰©çš„ç¨®å­æ˜¯ã€Œè£¸éœ²ã€çš„ï¼Œæ„æ€æ˜¯æ²’æœ‰æœå¯¦åŒ…è£¹ã€‚éŠ€æï¼ˆGinkgo bilobaï¼‰æ˜¯è£¸å­æ¤ç‰©ä¸­æœ€å¤è€çš„ã€Œæ´»åŒ–çŸ³ã€ï¼Œå…¶ç¥–å…ˆå¯è¿½æº¯è‡³2å„„7åƒè¬å¹´å‰ï¼Œæé¾æ›¾åœ¨éŠ€ææ¨¹ä¸‹ä¹˜æ¶¼ï¼é¦™æ¸¯çš„éƒŠé‡å…¬åœ’ä¸­å°±æœ‰æ¾æ¨¹å’Œç¾…æ¼¢æ¾ç­‰è£¸å­æ¤ç‰©ã€‚',
            'æœ‰èŠ±æ¤ç‰©':   'è¢«å­æ¤ç‰©æ˜¯åœ°çƒä¸Šæœ€æˆåŠŸçš„æ¤ç‰©é¡ç¾¤ï¼Œæ“æœ‰è¶…é30è¬å€‹å·²çŸ¥ç¨®ã€‚å®ƒå€‘èˆ‡èœœèœ‚ã€è´è¶ç­‰å‚³ç²‰è€…å…±åŒæ¼”åŒ–ï¼Œå½¢æˆäº†åœ°çƒç”Ÿæ…‹ç³»æœ€é‡è¦çš„å¤¥ä¼´é—œä¿‚ä¹‹ä¸€ã€‚å¾ç¨»ç±³ã€å°éº¥åˆ°è˜‹æœï¼Œäººé¡çš„ä¸»é£Ÿå¹¾ä¹å…¨ä¾†è‡ªè¢«å­æ¤ç‰©ã€‚',
            'è£¸å­æ¤ç‰©':   'è£¸å­æ¤ç‰©åœ¨è·ä»Šç´„3å„„å¹´å‰å‡ºç¾ï¼Œæ˜¯æœ€æ—©çš„ç¨®å­æ¤ç‰©ã€‚å®ƒå€‘æ›¾åœ¨æé¾æ™‚ä»£ä¸»å®°åœ°çƒã€‚éŠ€ææ˜¯ã€Œæ´»åŒ–çŸ³ã€ï¼Œå…¶å½¢æ…‹åœ¨2å„„å¤šå¹´é–“å¹¾ä¹æ²’æœ‰æ”¹è®Šï¼',
            'è•¨é¡æ¤ç‰©':   'è•¨é¡æ¤ç‰©åœ¨çŸ³ç‚­ç´€ï¼ˆç´„3.5å„„å¹´å‰ï¼‰ç¨±éœ¸åœ°çƒï¼Œå·¨å¤§çš„æ¨¹è•¨é«˜é”30å…¬å°ºã€‚ä»Šå¤©çš„ç…¤ç‚­å¤§å¤šç”±é‚£æ™‚çš„è•¨é¡æ£®æ—å½¢æˆã€‚å…¨çƒç¾å­˜ç´„1è¬ç¨®è•¨é¡ã€‚',
            'å–®å­è‘‰æ¤ç‰©': 'å–®å­è‘‰æ¤ç‰©åŒ…å«äººé¡æœ€é‡è¦çš„ç³§é£Ÿä½œç‰©ï¼šç¨»ç±³ã€å°éº¥ã€ç‰ç±³ã€‚ç¦¾æœ¬ç§‘ï¼ˆè‰ï¼‰è¦†è“‹äº†åœ°çƒé™¸åœ°é¢ç©çš„ç´„20%ï¼Œæ˜¯æœ€æˆåŠŸçš„æ¤ç‰©å®¶æ—ä¹‹ä¸€ã€‚',
            'é›™å­è‘‰æ¤ç‰©': 'é›™å­è‘‰æ¤ç‰©æ˜¯è¢«å­æ¤ç‰©ä¸­ç¨®é¡æœ€å¤šçš„ä¸€ç¾¤ï¼Œç´„ä½”é–‹èŠ±æ¤ç‰©çš„75%ã€‚å¾å¾®å°çš„é‡èŠ±åˆ°å·¨å¤§çš„é—Šè‘‰æ¨¹ï¼Œé›™å­è‘‰æ¤ç‰©çš„å¤šæ¨£æ€§ä»¤äººé©šæ­ã€‚',
        };
        const descriptions = {
            'éç¶­ç®¡æ¤ç‰©': 'æ‰¾ä¸€ç¨®æ²’æœ‰ç¶­ç®¡æŸçš„æ¤ç‰©ï¼Œä¾‹å¦‚è‹”è˜šã€åœ°è¡£æˆ–è—»é¡ã€‚',
            'ç¶­ç®¡æ¤ç‰©':   'æ‰¾ä»»ä½•æœ‰æ ¹ã€è–ã€è‘‰çš„æ¤ç‰©ï¼Œä¾‹å¦‚è•¨é¡ã€æ¾æ¨¹æˆ–é–‹èŠ±æ¤ç‰©ã€‚',
            'ç„¡ç¨®å­æ¤ç‰©': 'æ‰¾ä¸€ç¨®é å­¢å­ç¹æ®–çš„æ¤ç‰©ï¼Œè•¨é¡æ˜¯æœ€å¸¸è¦‹çš„ä¾‹å­ã€‚',
            'ç¨®å­æ¤ç‰©':   'æ‰¾ä¸€ç¨®ç”¨ç¨®å­ç¹æ®–çš„æ¤ç‰©â€”â€”é–‹èŠ±æ¤ç‰©æˆ–æ¯¬æœæ¤ç‰©éƒ½ç®—ã€‚',
            'ç„¡èŠ±æ¤ç‰©':   'æ‰¾ä¸€ç¨®ç”¨æ¯¬æœç¹æ®–çš„æ¤ç‰©ï¼Œä¾‹å¦‚æ¾æ¨¹ã€æ‰æ¨¹ã€éŠ€ææˆ–è˜‡éµã€‚',
            'æœ‰èŠ±æ¤ç‰©':   'æ‰¾ä»»ä½•ä¸€ç¨®æœƒé–‹èŠ±çš„æ¤ç‰©â€”â€”è·¯é‚Šçš„é‡èŠ±æˆ–èŠ±åœƒçš„æ¤ç‰©éƒ½å¯ä»¥ã€‚',
            'è£¸å­æ¤ç‰©':   'æ‰¾ä¸€ç¨®ç¨®å­è£¸éœ²ã€ç”¨æ¯¬æœç¹æ®–çš„æ¤ç‰©ï¼Œå¦‚æ¾æ¨¹ã€æ‰æ¨¹ã€éŠ€æã€‚',
            'è•¨é¡æ¤ç‰©':   'æ‰¾ä¸€ç¨®é å­¢å­ç¹æ®–çš„è•¨é¡ï¼Œæ³¨æ„ç¾½ç‹€è¤‡è‘‰å’Œè‘‰èƒŒå­¢å­å›Šã€‚',
            'å–®å­è‘‰æ¤ç‰©': 'æ‰¾ä¸€ç¨®å¹³è¡Œè„ˆè‘‰ç‰‡çš„æ¤ç‰©ï¼Œå¦‚ç¦¾è‰ã€ç™¾åˆã€æ£•æ«šæˆ–ç«¹å­ã€‚',
            'é›™å­è‘‰æ¤ç‰©': 'æ‰¾ä¸€ç¨®ç¶²ç‹€è„ˆè‘‰ç‰‡çš„é–‹èŠ±æ¤ç‰©ï¼Œå¦‚ç«ç‘°ã€å‘æ—¥è‘µæˆ–æ¦•æ¨¹ã€‚',
        };
        const icons = {
            'éç¶­ç®¡æ¤ç‰©': 'ğŸŒ¿', 'ç¶­ç®¡æ¤ç‰©': 'ğŸŒ±', 'ç„¡ç¨®å­æ¤ç‰©': 'ğŸƒ',
            'ç¨®å­æ¤ç‰©': 'ğŸŒ°', 'ç„¡èŠ±æ¤ç‰©': 'ğŸŒ²', 'æœ‰èŠ±æ¤ç‰©': 'ğŸŒ¸',
            'è£¸å­æ¤ç‰©': 'ğŸŒ²', 'è•¨é¡æ¤ç‰©': 'â˜˜ï¸', 'å–®å­è‘‰æ¤ç‰©': 'ğŸŒ¾', 'é›™å­è‘‰æ¤ç‰©': 'ğŸŒ»',
        };
        return { hints, extras, descriptions, icons };
    }

    // Note: innerHTML usage here is safe â€” all content is from hardcoded static data, not user input
    function renderChallengeScreen() {
        const screen = screens.challenge;
        const { challenge, xpMultiplier } = gameState;
        const currentCategory = challenge.currentMissions[challenge.currentIndex];
        const { descriptions, icons } = getChallengeData();

        screen.innerHTML = '<div class="flex flex-col h-full">'
            + '<h2 class="text-xl sm:text-2xl font-bold text-center text-emerald-700 mb-4">æ¤ç‰©æŒ‘æˆ°</h2>'
            + '<div class="bg-white rounded-xl shadow-md p-5 mb-4 flex-grow flex flex-col justify-center items-center text-center">'
            + '<div class="text-6xl mb-4">' + icons[currentCategory] + '</div>'
            + '<p class="text-xs text-gray-500 uppercase tracking-wider mb-1">ç•¶å‰æŒ‘æˆ°</p>'
            + '<h3 class="text-2xl font-bold text-emerald-700 mb-3">' + currentCategory + '</h3>'
            + '<p class="text-sm text-gray-600 leading-relaxed">' + descriptions[currentCategory] + '</p>'
            + '</div>'
            + '<div class="flex justify-around bg-emerald-50 rounded-lg p-3 mb-4 text-center">'
            + '<div><p class="text-xs text-gray-500">ç­”å°çå‹µ</p><p class="font-bold text-emerald-600">+' + (5 * xpMultiplier) + ' XP</p></div>'
            + '<div class="border-l border-emerald-200"></div>'
            + '<div><p class="text-xs text-gray-500">ç­”éŒ¯çå‹µ</p><p class="font-bold text-gray-400">+' + (2 * xpMultiplier) + ' XP</p></div>'
            + '</div>'
            + '<div class="grid grid-cols-2 gap-3">'
            + '<button id="challenge-camera-btn" class="btn bg-emerald-500 text-white p-4 rounded-lg font-semibold">ğŸ“· æ‹ç…§</button>'
            + '<label for="plant-input" class="btn bg-gray-200 text-gray-800 p-4 rounded-lg cursor-pointer text-center font-semibold block">ğŸ–¼ï¸ ç›¸ç°¿</label>'
            + '</div>'
            + '</div>';

        document.getElementById('challenge-camera-btn').addEventListener('click', () => startCamera());
    }

    async function processImage(base64Data, imageSrc) {
        if (gameState.isProcessing) return;
        gameState.isProcessing = true;
        navigateTo('loading');
        if (gameState.inventory.specialFeed > 0) {
            gameState.inventory.specialFeed--;
            gameState.xpMultiplier = 2;
            showModal('<div class="text-6xl mb-4">ğŸ§ª</div><h3 class="text-2xl font-bold mb-2">æ•ˆæœç™¼å‹•ï¼</h3><p class="text-gray-600 mb-6">ç¥å¥‡ç‡Ÿé¤Šæ¶²ç”Ÿæ•ˆï¼Œæœ¬æ¬¡ç¶“é©—å€¼åŠ å€ï¼</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">ç¹¼çºŒ</button>');
        }
        const targetCategory = gameState.challenge.currentMissions[gameState.challenge.currentIndex];
        await validatePlantForChallenge(base64Data, imageSrc, targetCategory);
    }

    async function validatePlantForChallenge(base64ImageData, imageSrc, targetCategory) {
        const prompt = 'ä½ æ˜¯ä¸€ä½æ¤ç‰©å­¸æ•™å¸«ã€‚è«‹åˆ†æåœ–ç‰‡ä¸­çš„æ¤ç‰©ï¼Œä¸¦åˆ¤æ–·å®ƒæ˜¯å¦å±¬æ–¼ã€Œ' + targetCategory + 'ã€é€™å€‹é¡åˆ¥ã€‚\n\n'
            + 'é¦–å…ˆï¼Œè«‹ç¢ºèªåœ–ç‰‡ä¸­æ˜¯å¦æœ‰æ¤ç‰©ã€‚è‹¥ç„¡æ¤ç‰©ï¼Œå›å‚³ isPlant: falseã€‚\n\n'
            + 'è‹¥æœ‰æ¤ç‰©ï¼Œè«‹æ ¹æ“šä»¥ä¸‹å®šç¾©åˆ¤æ–·å®ƒæ˜¯å¦å±¬æ–¼ç›®æ¨™é¡åˆ¥ï¼š\n'
            + '- éç¶­ç®¡æ¤ç‰©ï¼šè‹”è˜šã€åœ°è¡£ã€è—»é¡ç­‰æ²’æœ‰ç¶­ç®¡æŸçš„æ¤ç‰©\n'
            + '- ç¶­ç®¡æ¤ç‰©ï¼šæ‰€æœ‰è•¨é¡æ¤ç‰©ã€è£¸å­æ¤ç‰©ã€è¢«å­æ¤ç‰©ï¼ˆæœ‰æ ¹è–è‘‰ç¶­ç®¡æŸç³»çµ±çš„æ¤ç‰©ï¼‰\n'
            + '- ç„¡ç¨®å­æ¤ç‰©ï¼šåƒ…é™è•¨é¡æ¤ç‰©åŠå…¶è¿‘è¦ªï¼ˆæœ‰ç¶­ç®¡æŸä½†é å­¢å­ç¹æ®–ï¼‰\n'
            + '- ç¨®å­æ¤ç‰©ï¼šæ‰€æœ‰è£¸å­æ¤ç‰©ï¼ˆæ¾ã€æ‰ã€éŠ€æï¼‰å’Œè¢«å­æ¤ç‰©ï¼ˆé–‹èŠ±æ¤ç‰©ï¼‰\n'
            + '- ç„¡èŠ±æ¤ç‰©ï¼šåƒ…é™è£¸å­æ¤ç‰©ï¼ˆæ¾ã€æ‰ã€æŸã€éŠ€æã€è˜‡éµï¼Œç¨®å­è£¸éœ²ç„¡æœå¯¦ï¼‰\n'
            + '- æœ‰èŠ±æ¤ç‰©ï¼šæ‰€æœ‰è¢«å­æ¤ç‰©ï¼ˆå–®å­è‘‰å’Œé›™å­è‘‰ï¼Œé–‹èŠ±ä¸¦æœ‰æœå¯¦åŒ…è£¹ç¨®å­ï¼‰\n\n'
            + 'ç›®æ¨™é¡åˆ¥ï¼š' + targetCategory + '\n\n'
            + 'è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å‚³ï¼ˆä¸è¦åŠ ä»»ä½•è§£é‡‹ï¼‰ï¼š\n'
            + '{ "isPlant": true, "matchesCategory": true, "plantName": "æ¤ç‰©ä¸­æ–‡å", "scientificName": "æ‹‰ä¸å­¸å", '
            + '"plantType": "éç¶­ç®¡æ¤ç‰©ã€ç¶­ç®¡æ¤ç‰©ã€ç„¡ç¨®å­æ¤ç‰©ã€ç¨®å­æ¤ç‰©ã€ç„¡èŠ±æ¤ç‰©ã€æœ‰èŠ±æ¤ç‰© ä¹‹ä¸€", '
            + '"funFact": "ç°¡çŸ­æœ‰è¶£çŸ¥è­˜ï¼ˆ30å­—å·¦å³ï¼‰" }\n\n'
            + 'è‹¥ä¸æ˜¯æ¤ç‰©ï¼Œå›å‚³ï¼š\n'
            + '{ "isPlant": false, "matchesCategory": false, "plantName": "", "scientificName": "", "plantType": "", "funFact": "" }';

        const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64ImageData } }] }],
            generationConfig: { responseMimeType: "application/json" }
        };

        try {
            const workerUrl = getWorkerUrl();
            if (!workerUrl) {
                showModal('<div class="text-6xl mb-4">âš ï¸</div><h3 class="text-2xl font-bold mb-2">å°šæœªè¨­å®š API ç¶²å€</h3><p class="text-gray-600 mb-6">è«‹å…ˆåˆ°ä¸»é é»æ“Š âš™ï¸ è¨­å®š API ä¼ºæœå™¨ç¶²å€ã€‚</p><button class="modal-close-btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">äº†è§£</button>', () => {
                    navigateTo('challenge');
                    gameState.isProcessing = false;
                    gameState.xpMultiplier = 1;
                });
                return;
            }
            const response = await fetch(workerUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('API request failed: ' + response.status, errorText);
                throw new Error('API request failed: ' + response.status);
            }

            const result = await response.json();
            console.log('API Response:', result);

            if (!result.candidates || !result.candidates[0] || !result.candidates[0].content || !result.candidates[0].content.parts || !result.candidates[0].content.parts[0]) {
                console.error('API response format error:', result);
                throw new Error('API response format error');
            }

            const data = JSON.parse(result.candidates[0].content.parts[0].text);
            console.log('Parsed challenge data:', data);

            if (!data.isPlant) {
                showModal('<div class="text-6xl mb-4">ğŸ¤”</div><h3 class="text-2xl font-bold mb-2">é€™ä¸æ˜¯æ¤ç‰©å–”</h3><p class="text-gray-600 mb-6">è«‹æ‰¾ä¸€ç¨®æ¤ç‰©ä¾†æŒ‘æˆ°ï¼</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">å†è©¦ä¸€æ¬¡</button>', () => {
                    navigateTo('challenge');
                    gameState.isProcessing = false;
                    gameState.xpMultiplier = 1;
                });
                return;
            }

            // Add to pokedex if new (regardless of correct/wrong)
            const validPokedexTypes = ['éç¶­ç®¡æ¤ç‰©', 'ç¶­ç®¡æ¤ç‰©', 'ç„¡ç¨®å­æ¤ç‰©', 'ç¨®å­æ¤ç‰©', 'ç„¡èŠ±æ¤ç‰©', 'æœ‰èŠ±æ¤ç‰©'];
            if (data.plantName && validPokedexTypes.includes(data.plantType) && !gameState.pokedex[data.plantName]) {
                const thumbnail = await compressImageForStorage(imageSrc);
                gameState.pokedex[data.plantName] = {
                    name: data.plantName,
                    scientificName: data.scientificName || '',
                    type: data.plantType,
                    image: thumbnail,
                    fact: data.funFact
                };
            }

            renderChallengeResult(data, imageSrc, targetCategory, data.matchesCategory);

        } catch (error) {
            console.error("API error:", error);
            showModal('<div class="text-6xl mb-4">ğŸ˜¢</div><h3 class="text-2xl font-bold mb-2">åˆ†æå¤±æ•—</h3><p class="text-gray-600 mb-6">ç„¡æ³•è¾¨è­˜åœ–ç‰‡ï¼Œè«‹æ›ä¸€å¼µè©¦è©¦ã€‚</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">ç¹¼çºŒ</button>', () => {
                navigateTo('challenge');
                gameState.isProcessing = false;
                gameState.xpMultiplier = 1;
            });
        }
    }

    // Note: innerHTML usage here is safe â€” imageSrc is from FileReader/canvas dataURI (not user text),
    // and all other content is from hardcoded getChallengeData() or AI-parsed plant names
    function renderChallengeResult(data, imageSrc, targetCategory, isCorrect) {
        const screen = screens.challenge;
        const { hints, extras } = getChallengeData();
        const xpReward = (isCorrect ? 5 : 2) * gameState.xpMultiplier;

        const plantInfoHtml = data.plantName
            ? '<div class="bg-white rounded-xl shadow-sm p-4 mb-4 text-center">'
              + '<p class="font-bold text-emerald-700 text-lg">' + data.plantName + '</p>'
              + (data.scientificName ? '<p class="text-xs text-gray-400 italic">' + data.scientificName + '</p>' : '')
              + (data.funFact ? '<p class="text-sm text-gray-600 mt-2 bg-emerald-50 p-2 rounded-lg">' + data.funFact + '</p>' : '')
              + '</div>'
            : '';

        const feedbackColor = isCorrect ? 'emerald' : 'amber';
        const feedbackIcon = isCorrect ? 'ğŸ‰' : 'ğŸ¤”';
        const feedbackTitle = isCorrect ? 'ç­”å°äº†ï¼' : 'ç­”éŒ¯äº†ï¼';
        const knowledgeLabel = isCorrect ? 'ğŸ’¡ å»¶ä¼¸çŸ¥è­˜' : 'ğŸ’¡ æç¤º';
        const knowledgeText = isCorrect ? extras[targetCategory] : hints[targetCategory];
        const btnLabel = isCorrect ? 'ä¸‹ä¸€é¡Œ â†’' : 'å†è©¦ä¸€æ¬¡ â†’';

        screen.innerHTML = '<div class="flex flex-col h-full">'
            + '<h2 class="text-xl font-bold text-center text-emerald-700 mb-4">æŒ‘æˆ°çµæœ</h2>'
            + '<img src="' + imageSrc + '" class="w-full max-h-40 object-cover rounded-xl shadow-md mb-4" alt="æ¤ç‰©ç…§ç‰‡">'
            + '<div class="rounded-xl p-4 mb-4 text-center bg-' + feedbackColor + '-100 border-2 border-' + feedbackColor + '-400">'
            + '<div class="text-4xl mb-1">' + feedbackIcon + '</div>'
            + '<p class="font-bold text-lg text-' + feedbackColor + '-700">' + feedbackTitle + '</p>'
            + '<p class="text-sm text-gray-600 mt-1">ç²å¾— <b>' + xpReward + '</b> é»ç¶“é©—å€¼</p>'
            + '</div>'
            + plantInfoHtml
            + '<div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">'
            + '<p class="text-sm font-semibold text-blue-700 mb-2">' + knowledgeLabel + '</p>'
            + '<p class="text-sm text-gray-700 leading-relaxed">' + knowledgeText + '</p>'
            + '</div>'
            + '<button id="challenge-action-btn" class="btn w-full bg-emerald-500 text-white font-bold py-3 rounded-lg shadow-lg mt-auto">' + btnLabel + '</button>'
            + '</div>';

        // Award XP
        gameState.xp += xpReward;
        if (isCorrect) {
            gameState.stats.correctAnswers++;
            checkAchievements('correctAnswers', gameState.stats.correctAnswers);
        }
        renderAll();
        saveGameState();

        // Show challenge screen directly (bypass navigateTo to avoid re-render)
        Object.values(screens).forEach(s => s && s.classList.add('hidden'));
        screens.challenge.classList.remove('hidden');
        Object.values(navButtons).forEach(b => b && b.classList.remove('active'));
        if (navButtons.challenge) navButtons.challenge.classList.add('active');
        gameState.isProcessing = false;

        document.getElementById('challenge-action-btn').addEventListener('click', () => {
            handleChallengeAction(isCorrect, targetCategory);
        });
    }

    function handleChallengeAction(isCorrect, targetCategory) {
        // Count as a feed for achievements
        gameState.stats.feeds++;
        checkAchievements('feeds', gameState.stats.feeds);

        // Update daily challenge task
        const today = getTodayString();
        if (gameState.tasks.dailyChallenge && !gameState.tasks.dailyChallenge.completedToday) {
            gameState.tasks.dailyChallenge.completedToday = true;
            gameState.tasks.dailyChallenge.lastFeedDate = today;
            queueNotification('<div class="text-6xl mb-4">ğŸ””</div><h3 class="text-2xl font-bold mb-2">ä»»å‹™é€²åº¦æ›´æ–°</h3><p class="text-gray-600 mb-6">æ‚¨å·²å®Œæˆã€Œæ¯æ—¥æŒ‘æˆ°ã€ä»»å‹™ï¼Œè¨˜å¾—åˆ°ä»»å‹™ä¸­å¿ƒé ˜å–çå‹µï¼</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">ç¹¼çºŒ</button>');
        }

        // Update category-specific task if correct
        if (isCorrect) {
            const taskKeyMap = {
                'éç¶­ç®¡æ¤ç‰©': 'challengeNonVascular',
                'ç¶­ç®¡æ¤ç‰©':   'challengeVascular',
                'ç„¡ç¨®å­æ¤ç‰©': 'challengeSeedless',
                'ç¨®å­æ¤ç‰©':   'challengeSeeded',
                'ç„¡èŠ±æ¤ç‰©':   'challengeNonFlowering',
                'æœ‰èŠ±æ¤ç‰©':   'challengeFlowering',
            };
            const taskKey = taskKeyMap[targetCategory];
            if (taskKey && gameState.tasks[taskKey] && !gameState.tasks[taskKey].completedToday) {
                gameState.tasks[taskKey].completedToday = true;
                gameState.tasks[taskKey].lastFeedDate = today;
            }

            // Advance to next challenge
            gameState.challenge.currentIndex++;
            if (gameState.challenge.currentIndex >= 6) {
                gameState.challenge.currentIndex = 0;
                gameState.challenge.currentMissions = shuffleArray(ALL_CHALLENGE_CATEGORIES);
                gameState.challenge.cyclesCompleted++;
            }
        }
        // If incorrect: currentIndex stays the same â€” user retries same category

        checkLevelUp();
        gameState.xpMultiplier = 1;
        saveGameState();
        navigateTo('challenge');
    }

    function checkLevelUp() {
        let levelsGained = 0;
        
        while (true) {
            const xpNeeded = calculateXpToNextLevel(gameState.level);
            if (gameState.xp < xpNeeded) break;
            
            gameState.xp -= xpNeeded;
            gameState.level++;
            levelsGained++;
            checkAchievements('level', gameState.level);
        }
        
        if (levelsGained > 0) {
            checkEvolution();
            renderAll();
            saveGameState();
            
            const levelText = levelsGained > 1 ? `å‡ç´šäº† ${levelsGained} ç´š` : 'å‡ç´šäº†';
            queueNotification(`<div class="text-6xl mb-4">ğŸŠ</div><h3 class="text-2xl font-bold mb-2">${levelText}ï¼</h3><p class="text-gray-600 mb-6">æ­å–œï¼æ‚¨çš„å¯µç‰©å‡ç´šåˆ° <b>Lv.${gameState.level}</b>ï¼</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">å¤ªæ£’äº†ï¼</button>`);
        }
    }
    
    function checkEvolution() {
        const petType = gameState.pet.type;
        const currentLevel = gameState.level;
        let newStage = 1;
        
        if (currentLevel >= 3) {
            newStage = 3;
        } else if (currentLevel >= 2) {
            newStage = 2;
        }
        
        if (newStage !== gameState.pet.stage) {
            const oldStage = gameState.pet.stage;
            gameState.pet.stage = newStage;
            
            if (petEvolutionData[petType] && petEvolutionData[petType].stages[newStage]) {
                const evolutionInfo = petEvolutionData[petType].stages[newStage];
                gameState.pet.visual = evolutionInfo.visual;
                renderPet();
                saveGameState();
                
                if (oldStage < newStage) {
                    queueNotification(`<div class="text-6xl mb-4">âœ¨</div><h3 class="text-2xl font-bold mb-2">é€²åŒ–äº†ï¼</h3><p class="text-gray-600 mb-6"><b>${gameState.pet.name}</b> é€²åŒ–äº†ï¼</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">å¤ªé…·äº†ï¼</button>`);
                }
            }
        }
    }
    
    function checkAchievements(metric, value) {
        Object.keys(gameState.achievements).forEach(key => {
            const ach = gameState.achievements[key];
            if (ach.metric === metric && !ach.unlocked) {
                ach.progress = value;
                if (ach.progress >= ach.target) {
                    ach.unlocked = true;
                    gameState.seeds += 50;
                    queueNotification(`<div class="text-6xl mb-4">ğŸ†</div><h3 class="text-2xl font-bold mb-2">æˆå°±è§£é–ï¼</h3><p class="text-gray-600 mb-4"><b>${ach.name}</b></p><p class="text-sm text-gray-500 mb-6">${ach.description}</p><p class="text-emerald-600 font-bold">ç²å¾—çå‹µï¼š50 ğŸŒ¿</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">å¤ªå¥½äº†ï¼</button>`);
                }
            }
        });
        saveGameState();
    }
    
    function checkDailyTasks() {
        const today = getTodayString();
        
        Object.values(gameState.tasks).forEach(task => {
            if (task.lastFeedDate && task.lastFeedDate !== today) {
                task.completedToday = false;
                task.claimedToday = false;
            }
        });
        
        saveGameState();
    }
    
    function initializeGame(petName, petImageURL, petType) {
        gameState.pet.type = petType;
        gameState.pet.stage = 1;
        gameState.pet.name = petName;
        
        if (petEvolutionData[petType] && petEvolutionData[petType].stages[1]) {
            const stageData = petEvolutionData[petType].stages[1];
            gameState.pet.visual = stageData.visual;
        } else {
            gameState.pet.visual = petImageURL;
        }
        
        gameState.gameStarted = true;
        saveGameState();
        screens.start.classList.add('hidden');
        mainNav.classList.remove('hidden');
        renderAll();
        navigateTo('home');
    }

    // --- Competition Mode ---
    const FAKE_GPS_LOCATIONS = ['é¦™æ¸¯å…¬åœ’', 'ä¹é¾å…¬åœ’', 'å˜‰é“ç†è¾²å ´'];
    const FAKE_LEADERBOARD_PLAYERS = [
        { name: 'æ¤ç‰©åšå£«å°æ˜', avatar: 'ğŸ§‘â€ğŸ”¬' }, { name: 'èŠ±èŠ±é”äºº', avatar: 'ğŸŒº' },
        { name: 'ç¶ æ‰‹æŒ‡é˜¿ç²', avatar: 'ğŸŒ¿' }, { name: 'æ¢éšªå®¶å°é™³', avatar: 'ğŸ§­' },
        { name: 'å¤§è‡ªç„¶è§€å¯Ÿå“¡', avatar: 'ğŸ”' }, { name: 'æ ¡åœ’æ¤ç‰©ç‹', avatar: 'ğŸ‘‘' },
        { name: 'è‹”è˜šçµäºº', avatar: 'ğŸ€' }, { name: 'ç¨®å­æ”¶é›†å®¶', avatar: 'ğŸŒ°' },
        { name: 'è•¨é¡æ„›å¥½è€…', avatar: 'â˜˜ï¸' }, { name: 'èŠ±èªå°ç²¾éˆ', avatar: 'ğŸ§š' },
    ];

    function checkMonthlyCompetitionReset() {
        const currentMonth = new Date().toISOString().slice(0, 7);
        if (gameState.competition.monthlyMonth !== currentMonth) {
            gameState.competition.monthlyScore = 0;
            gameState.competition.monthlyCorrect = 0;
            gameState.competition.monthlyWrong = 0;
            gameState.competition.monthlyPlantsFound = [];
            gameState.competition.monthlyMonth = currentMonth;
            gameState.competition.session = null;
            saveGameState();
        }
    }

    function getMockGPSLocation() {
        return FAKE_GPS_LOCATIONS[Math.floor(Math.random() * FAKE_GPS_LOCATIONS.length)];
    }

    function generateFakeLeaderboard(userMonthlyScore) {
        const fakeEntries = FAKE_LEADERBOARD_PLAYERS.map(p => ({
            name: p.name, avatar: p.avatar,
            score: Math.floor(Math.random() * 30) + 2, isUser: false,
        }));
        fakeEntries.push({ name: 'æˆ‘', avatar: 'â­', score: userMonthlyScore, isUser: true });
        fakeEntries.sort((a, b) => b.score - a.score || a.name.localeCompare(b.name));
        return fakeEntries.map((entry, i) => ({ ...entry, rank: i + 1 }));
    }

    function formatCompetitionTime(ms) {
        const totalSec = Math.max(0, Math.floor(ms / 1000));
        const h = Math.floor(totalSec / 3600);
        const m = Math.floor((totalSec % 3600) / 60);
        const s = totalSec % 60;
        return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }

    // Note: innerHTML usage in competition functions follows the same pattern as existing code â€”
    // all content is from hardcoded static data or AI-parsed plant names, not user input
    function renderCompetitionLobby() {
        const screen = screens.competition;
        const comp = gameState.competition;
        const leaderboard = generateFakeLeaderboard(comp.monthlyScore);
        const currentMonth = new Date().toLocaleDateString('zh-Hant', { year: 'numeric', month: 'long' });
        const hasActiveSession = comp.session && Date.now() < comp.session.endTime;

        const top3 = leaderboard.slice(0, 3);
        const podiumLabels = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        const podiumColors = ['podium-gold', 'podium-silver', 'podium-bronze'];
        const podiumOrder = [1, 0, 2];
        const podiumHeights = ['h-20', 'h-28', 'h-16'];

        let podiumHtml = '<div class="flex justify-center items-end gap-3 mb-6">';
        podiumOrder.forEach((idx, i) => {
            if (top3[idx]) {
                const p = top3[idx];
                podiumHtml += '<div class="flex flex-col items-center">'
                    + '<div class="text-2xl mb-1">' + p.avatar + '</div>'
                    + '<p class="text-xs font-bold truncate max-w-[80px] ' + (p.isUser ? 'text-emerald-700' : 'text-gray-700') + '">' + p.name + '</p>'
                    + '<p class="text-sm font-bold">' + p.score + ' åˆ†</p>'
                    + '<div class="w-20 ' + podiumHeights[i] + ' ' + podiumColors[idx] + ' rounded-t-lg flex items-center justify-center text-white text-lg font-bold mt-1">' + podiumLabels[idx] + '</div>'
                    + '</div>';
            }
        });
        podiumHtml += '</div>';

        let listHtml = '<div class="bg-white rounded-xl shadow-sm overflow-hidden mb-4 max-h-48 overflow-y-auto">';
        leaderboard.forEach(entry => {
            const rowClass = entry.isUser ? 'leaderboard-user-row' : '';
            listHtml += '<div class="flex items-center justify-between px-4 py-2 border-b border-gray-100 ' + rowClass + '">'
                + '<div class="flex items-center gap-2">'
                + '<span class="w-6 text-center font-bold text-sm text-gray-500">' + entry.rank + '</span>'
                + '<span class="text-lg">' + entry.avatar + '</span>'
                + '<span class="text-sm font-medium ' + (entry.isUser ? 'text-emerald-700' : '') + '">' + entry.name + '</span>'
                + '</div>'
                + '<span class="font-bold text-sm">' + entry.score + ' åˆ†</span>'
                + '</div>';
        });
        listHtml += '</div>';

        const buttonHtml = hasActiveSession
            ? '<button id="competition-resume-btn" class="btn w-full bg-amber-500 text-white font-bold py-3 rounded-lg shadow-lg">âš¡ ç¹¼çºŒç«¶è³½</button>'
            : '<button id="competition-start-btn" class="btn w-full bg-emerald-500 text-white font-bold py-3 rounded-lg shadow-lg">âš¡ é–‹å§‹ç«¶è³½ï¼ˆ1å°æ™‚ï¼‰</button>';

        screen.innerHTML = '<div class="flex flex-col h-full">'
            + '<h2 class="text-xl sm:text-2xl font-bold text-center text-emerald-700 mb-2">ç«¶è³½æ¨¡å¼</h2>'
            + '<p class="text-center text-sm text-gray-500 mb-4">' + currentMonth + ' æ’è¡Œæ¦œ</p>'
            + podiumHtml + listHtml
            + '<div class="bg-emerald-50 rounded-lg p-3 mb-4 text-center">'
            + '<p class="text-xs text-gray-500">æˆ‘çš„æœ¬æœˆæˆç¸¾</p>'
            + '<p class="text-2xl font-bold text-emerald-700">' + comp.monthlyScore + ' åˆ†</p>'
            + '<p class="text-xs text-gray-400">ç­”å° ' + comp.monthlyCorrect + ' / ç­”éŒ¯ ' + comp.monthlyWrong + '</p>'
            + '</div>'
            + buttonHtml
            + '</div>';

        if (hasActiveSession) {
            document.getElementById('competition-resume-btn').addEventListener('click', () => {
                showCompetitionActiveScreen();
                startCompetitionTimer();
            });
        } else {
            document.getElementById('competition-start-btn').addEventListener('click', startCompetitionSession);
        }
    }

    function startCompetitionSession() {
        // Show GPS detecting popup
        const location = getMockGPSLocation();
        showModal(
            '<div class="text-6xl mb-4">ğŸ“¡</div>'
            + '<h3 class="text-2xl font-bold mb-2">æ­£åœ¨å®šä½...</h3>'
            + '<div class="animate-spin rounded-full h-10 w-10 border-b-4 border-blue-500 mx-auto mb-4"></div>'
            + '<p class="text-gray-500 text-sm">æ­£åœ¨åµæ¸¬æ‚¨çš„ä½ç½®</p>'
        );
        // Simulate GPS detection delay
        setTimeout(() => {
            hideModal();
            setTimeout(() => {
                showModal(
                    '<div class="text-6xl mb-4">ğŸ“</div>'
                    + '<h3 class="text-2xl font-bold mb-2 text-blue-700">å®šä½æˆåŠŸï¼</h3>'
                    + '<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">'
                    + '<p class="text-lg font-bold text-blue-700">' + location + '</p>'
                    + '<p class="text-xs text-blue-500 mt-1">å·²ç¢ºèªæ‚¨åœ¨ç«¶è³½ç¯„åœå…§</p>'
                    + '</div>'
                    + '<button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full w-full">é–‹å§‹ç«¶è³½ï¼</button>',
                    () => {
                        const now = Date.now();
                        gameState.competition.session = {
                            startTime: now,
                            endTime: now + COMPETITION_TIME_LIMIT_MS,
                            mockLocation: location,
                            types: shuffleArray([...COMPETITION_CATEGORIES]),
                            currentIndex: 0,
                            results: {},
                        };
                        saveGameState();
                        showCompetitionActiveScreen();
                        startCompetitionTimer();
                    }
                );
            }, 350);
        }, 1500);
    }

    function showCompetitionActiveScreen() {
        Object.values(screens).forEach(s => s && s.classList.add('hidden'));
        screens.competitionActive.classList.remove('hidden');
        Object.values(navButtons).forEach(b => b && b.classList.remove('active'));
        if (navButtons.competition) navButtons.competition.classList.add('active');
        mainNav.classList.add('hidden');
        renderCompetitionActiveUI();
    }

    function renderCompetitionActiveUI() {
        const session = gameState.competition.session;
        if (!session) return;
        const remaining = Math.max(0, session.endTime - Date.now());
        const { icons, descriptions, hints } = getChallengeData();
        const timerWarning = remaining < 5 * 60 * 1000 ? ' warning' : '';
        const isFinished = session.currentIndex >= session.types.length;
        const currentType = isFinished ? null : session.types[session.currentIndex];

        // Build progress dots
        let dotsHtml = '<div class="flex justify-center gap-1.5 flex-wrap mx-4 mt-3">';
        session.types.forEach((type, i) => {
            let dotClass = 'pending';
            let dotContent = i + 1;
            if (session.results[type]) {
                const s = session.results[type].status;
                dotClass = s;
                dotContent = s === 'correct' ? 'âœ“' : s === 'incorrect' ? 'âœ—' : 'â€”';
            } else if (i === session.currentIndex) {
                dotClass = 'current';
            }
            dotsHtml += '<div class="progress-dot ' + dotClass + '">' + dotContent + '</div>';
        });
        dotsHtml += '</div>';

        // Action area
        let actionHtml;
        if (isFinished) {
            actionHtml = '<button id="competition-finish-btn" class="btn w-full bg-emerald-500 text-white font-bold py-4 rounded-full shadow-lg text-lg">ğŸ æŸ¥çœ‹çµæœ</button>';
        } else {
            actionHtml = '<div class="flex gap-3 w-full px-4">'
                + '<button id="competition-camera-btn" class="btn flex-1 bg-emerald-500 text-white font-bold py-4 rounded-full shadow-lg">ğŸ“· æ‹æ”æ¤ç‰©</button>'
                + '<button id="competition-skip-btn" class="btn flex-none bg-gray-200 text-gray-700 font-bold py-4 px-6 rounded-full shadow">â© è·³é</button>'
                + '</div>';
        }

        // Current type card
        let typeCardHtml = '';
        if (!isFinished) {
            typeCardHtml = '<div class="mx-4 mt-3 bg-white rounded-xl shadow-sm p-4 text-center">'
                + '<p class="text-xs text-gray-400 mb-1">ç›®æ¨™æ¤ç‰©é¡åˆ¥</p>'
                + '<div class="text-4xl mb-2">' + (icons[currentType] || 'ğŸŒ¿') + '</div>'
                + '<h3 class="text-xl font-bold text-emerald-700">' + currentType + '</h3>'
                + '<p class="text-sm text-gray-500 mt-1">' + (descriptions[currentType] || '') + '</p>'
                + '<p class="text-xs text-gray-400 mt-2 leading-relaxed">' + (hints[currentType] || '') + '</p>'
                + '</div>';
        }

        const screen = screens.competitionActive;
        screen.innerHTML = '<div class="flex flex-col h-full">'
            + '<div class="flex justify-between items-center p-4 bg-white shadow-sm">'
            + '<div class="text-center"><p class="text-xs text-gray-400">å‰©é¤˜æ™‚é–“</p><p id="competition-timer" class="text-2xl font-bold text-gray-800 competition-timer' + timerWarning + '">' + formatCompetitionTime(remaining) + '</p></div>'
            + '<div class="text-center"><p class="text-xs text-gray-400">é€²åº¦</p><p class="text-2xl font-bold text-emerald-600">ç¬¬ ' + Math.min(session.currentIndex + 1, session.types.length) + ' / ' + session.types.length + ' é¡Œ</p></div>'
            + '</div>'
            + '<div class="mx-4 mt-3 bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 flex items-center gap-2">'
            + '<span class="text-blue-500">ğŸ“</span>'
            + '<span class="text-sm text-blue-700">' + session.mockLocation + '</span>'
            + '<span class="text-xs text-green-500 ml-auto">GPS å·²å®šä½</span>'
            + '</div>'
            + dotsHtml
            + typeCardHtml
            + '<div class="flex-grow flex items-center justify-center">'
            + actionHtml
            + '</div>'
            + '<div class="px-4 pb-4">'
            + '<button id="competition-quit-btn" class="btn w-full bg-red-100 text-red-600 font-semibold py-3 rounded-lg border border-red-200 hover:bg-red-200 transition-colors">çµæŸç«¶è³½</button>'
            + '</div>'
            + '</div>';

        const cameraBtn = document.getElementById('competition-camera-btn');
        if (cameraBtn) cameraBtn.addEventListener('click', startCompetitionCamera);
        const skipBtn = document.getElementById('competition-skip-btn');
        if (skipBtn) skipBtn.addEventListener('click', skipCompetitionType);
        const finishBtn = document.getElementById('competition-finish-btn');
        if (finishBtn) finishBtn.addEventListener('click', () => endCompetitionSession(false));
        document.getElementById('competition-quit-btn').addEventListener('click', () => {
            showModal(
                '<div class="text-6xl mb-4">âš ï¸</div>'
                + '<h3 class="text-2xl font-bold mb-2">ç¢ºå®šçµæŸï¼Ÿ</h3>'
                + '<p class="text-gray-600 mb-6">çµæŸå¾Œæœ¬æ¬¡ç«¶è³½æˆç¸¾å°‡è¢«è¨˜éŒ„ã€‚</p>'
                + '<div class="flex gap-3">'
                + '<button id="competition-quit-confirm" class="flex-1 bg-red-500 text-white font-bold py-2 px-4 rounded-full">çµæŸ</button>'
                + '<button class="modal-close-btn flex-1 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full">å–æ¶ˆ</button>'
                + '</div>'
            );
            document.getElementById('competition-quit-confirm').addEventListener('click', () => {
                hideModal();
                setTimeout(() => endCompetitionSession(false), 350);
            });
        });
    }

    function skipCompetitionType() {
        const session = gameState.competition.session;
        if (!session || session.currentIndex >= session.types.length) return;
        const currentType = session.types[session.currentIndex];
        session.results[currentType] = { status: 'skipped' };
        session.currentIndex++;
        saveGameState();
        if (session.currentIndex >= session.types.length) {
            endCompetitionSession(false);
        } else {
            renderCompetitionActiveUI();
        }
    }

    function startCompetitionTimer() {
        clearInterval(competitionTimerInterval);
        competitionTimerInterval = setInterval(() => {
            const session = gameState.competition.session;
            if (!session) { clearInterval(competitionTimerInterval); return; }
            const remaining = session.endTime - Date.now();
            const timerEl = document.getElementById('competition-timer');
            if (timerEl) {
                timerEl.textContent = formatCompetitionTime(remaining);
                if (remaining < 5 * 60 * 1000) timerEl.classList.add('warning');
            }
            if (remaining <= 0) {
                clearInterval(competitionTimerInterval);
                endCompetitionSession(false);
            }
        }, 1000);
    }

    function endCompetitionSession(skipSummary) {
        clearInterval(competitionTimerInterval);
        const session = gameState.competition.session;
        if (!session) {
            mainNav.classList.remove('hidden');
            navigateTo('competition');
            return;
        }

        if (skipSummary) {
            gameState.competition.session = null;
            saveGameState();
            mainNav.classList.remove('hidden');
            return;
        }

        const { icons } = getChallengeData();
        const correct = Object.values(session.results).filter(r => r.status === 'correct').length;
        const incorrect = Object.values(session.results).filter(r => r.status === 'incorrect').length;
        const skipped = Object.values(session.results).filter(r => r.status === 'skipped').length;

        let resultsGridHtml = '<div class="text-left space-y-1.5 mb-3 max-h-48 overflow-y-auto">';
        session.types.forEach(type => {
            const result = session.results[type];
            let statusIcon, statusText, textColor;
            if (!result) { statusIcon = 'â¬œ'; statusText = 'æœªå®Œæˆ'; textColor = 'text-gray-400'; }
            else if (result.status === 'correct') { statusIcon = 'âœ…'; statusText = result.plantName || 'æ­£ç¢º'; textColor = 'text-emerald-600'; }
            else if (result.status === 'incorrect') { statusIcon = 'âŒ'; statusText = 'éŒ¯èª¤'; textColor = 'text-red-400'; }
            else { statusIcon = 'â©'; statusText = 'è·³é'; textColor = 'text-gray-400'; }
            resultsGridHtml += '<div class="flex items-center gap-2 text-sm">'
                + '<span>' + statusIcon + '</span>'
                + '<span class="font-medium">' + (icons[type] || '') + ' ' + type + '</span>'
                + '<span class="' + textColor + ' ml-auto">' + statusText + '</span>'
                + '</div>';
        });
        resultsGridHtml += '</div>';

        showModal(
            '<div class="text-6xl mb-3">ğŸ</div>'
            + '<h3 class="text-2xl font-bold mb-2">ç«¶è³½çµæŸï¼</h3>'
            + '<div class="bg-emerald-50 rounded-lg p-4 mb-3">'
            + '<p class="text-3xl font-bold text-emerald-700">' + correct + ' / ' + session.types.length + ' æ­£ç¢º</p>'
            + '</div>'
            + '<div class="flex justify-around mb-3 text-center">'
            + '<div><p class="text-xs text-gray-500">ç­”å°</p><p class="font-bold text-emerald-600">' + correct + '</p></div>'
            + '<div><p class="text-xs text-gray-500">ç­”éŒ¯</p><p class="font-bold text-red-400">' + incorrect + '</p></div>'
            + '<div><p class="text-xs text-gray-500">è·³é</p><p class="font-bold text-gray-400">' + skipped + '</p></div>'
            + '</div>'
            + resultsGridHtml
            + '<button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full w-full">è¿”å›ä¸»é </button>',
            () => {
                gameState.competition.session = null;
                saveGameState();
                mainNav.classList.remove('hidden');
                navigateTo('home');
            }
        );
    }

    async function startCompetitionCamera() {
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('competition-camera-feed').srcObject = videoStream;
            Object.values(screens).forEach(s => s && s.classList.add('hidden'));
            screens.competitionCamera.classList.remove('hidden');
        } catch (err) {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('competition-camera-feed').srcObject = videoStream;
                Object.values(screens).forEach(s => s && s.classList.add('hidden'));
                screens.competitionCamera.classList.remove('hidden');
            } catch (finalErr) {
                showModal('<div class="text-6xl mb-4">ğŸ˜Ÿ</div><h3 class="text-2xl font-bold mb-2">ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ</h3><p class="text-gray-600 mb-6">è«‹ç¢ºèªæ‚¨å·²æˆæ¬Šç€è¦½å™¨ä½¿ç”¨ç›¸æ©Ÿã€‚</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">äº†è§£</button>');
            }
        }
    }

    function competitionCapturePhoto() {
        const feed = document.getElementById('competition-camera-feed');
        canvas.width = feed.videoWidth;
        canvas.height = feed.videoHeight;
        canvas.getContext('2d').drawImage(feed, 0, 0, canvas.width, canvas.height);
        const dataUri = canvas.toDataURL('image/png');
        const base64Data = dataUri.split(',')[1];
        stopCamera();
        processCompetitionImage(base64Data, dataUri);
    }

    async function processCompetitionImage(base64Data, imageSrc) {
        const session = gameState.competition.session;
        if (!session || competitionIsProcessing || session.currentIndex >= session.types.length) return;
        competitionIsProcessing = true;

        Object.values(screens).forEach(s => s && s.classList.add('hidden'));
        screens.loading.classList.remove('hidden');

        const targetCategory = session.types[session.currentIndex];
        const prompt = 'ä½ æ˜¯ä¸€ä½æ¤ç‰©å­¸æ•™å¸«ã€‚è«‹åˆ†æåœ–ç‰‡ä¸­çš„æ¤ç‰©ï¼Œä¸¦åˆ¤æ–·å®ƒæ˜¯å¦å±¬æ–¼ã€Œ' + targetCategory + 'ã€é€™å€‹é¡åˆ¥ã€‚\n\n'
            + 'é¦–å…ˆï¼Œè«‹ç¢ºèªåœ–ç‰‡ä¸­æ˜¯å¦æœ‰æ¤ç‰©ã€‚è‹¥ç„¡æ¤ç‰©ï¼Œå›å‚³ isPlant: falseã€‚\n\n'
            + 'è‹¥æœ‰æ¤ç‰©ï¼Œè«‹æ ¹æ“šä»¥ä¸‹å®šç¾©åˆ¤æ–·å®ƒæ˜¯å¦å±¬æ–¼ç›®æ¨™é¡åˆ¥ï¼š\n'
            + '- éç¶­ç®¡æ¤ç‰©ï¼šè‹”è˜šã€åœ°è¡£ã€è—»é¡ç­‰æ²’æœ‰ç¶­ç®¡æŸçš„æ¤ç‰©\n'
            + '- ç¶­ç®¡æ¤ç‰©ï¼šæ‰€æœ‰è•¨é¡æ¤ç‰©ã€è£¸å­æ¤ç‰©ã€è¢«å­æ¤ç‰©ï¼ˆæœ‰æ ¹è–è‘‰ç¶­ç®¡æŸç³»çµ±çš„æ¤ç‰©ï¼‰\n'
            + '- ç„¡ç¨®å­æ¤ç‰©ï¼šåƒ…é™è•¨é¡æ¤ç‰©åŠå…¶è¿‘è¦ªï¼ˆæœ‰ç¶­ç®¡æŸä½†é å­¢å­ç¹æ®–ï¼‰\n'
            + '- è£¸å­æ¤ç‰©ï¼šæ¾ã€æ‰ã€æŸã€éŠ€æã€è˜‡éµç­‰ï¼Œç¨®å­è£¸éœ²åœ¨æ¯¬æœä¸­ï¼Œæ²’æœ‰æœå¯¦åŒ…è£¹\n'
            + '- è•¨é¡æ¤ç‰©ï¼šé å­¢å­ç¹æ®–çš„ç¶­ç®¡æ¤ç‰©ï¼Œæœ‰ç¾½ç‹€è¤‡è‘‰ï¼ŒåŒ…æ‹¬è•¨ã€çŸ³æ¾ã€æœ¨è³Š\n'
            + '- å–®å­è‘‰æ¤ç‰©ï¼šç¨®å­æœ‰ä¸€ç‰‡å­è‘‰çš„è¢«å­æ¤ç‰©ï¼Œå¹³è¡Œè„ˆè‘‰ç‰‡ï¼Œå¦‚ç¦¾è‰ã€ç™¾åˆã€è˜­èŠ±ã€æ£•æ«š\n'
            + '- é›™å­è‘‰æ¤ç‰©ï¼šç¨®å­æœ‰å…©ç‰‡å­è‘‰çš„è¢«å­æ¤ç‰©ï¼Œç¶²ç‹€è„ˆè‘‰ç‰‡ï¼Œå¦‚ç«ç‘°ã€è±†ç§‘ã€èŠç§‘\n'
            + '- æœ‰èŠ±æ¤ç‰©ï¼šæ‰€æœ‰è¢«å­æ¤ç‰©ï¼ˆå–®å­è‘‰å’Œé›™å­è‘‰ï¼Œé–‹èŠ±ä¸¦æœ‰æœå¯¦åŒ…è£¹ç¨®å­ï¼‰\n'
            + '- ç„¡èŠ±æ¤ç‰©ï¼šåƒ…é™è£¸å­æ¤ç‰©ï¼ˆæ¾ã€æ‰ã€æŸã€éŠ€æã€è˜‡éµï¼Œç¨®å­è£¸éœ²ç„¡æœå¯¦ï¼‰\n\n'
            + 'ç›®æ¨™é¡åˆ¥ï¼š' + targetCategory + '\n\n'
            + 'è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å‚³ï¼ˆä¸è¦åŠ ä»»ä½•è§£é‡‹ï¼‰ï¼š\n'
            + '{ "isPlant": true, "matchesCategory": true, "plantName": "æ¤ç‰©ä¸­æ–‡å", "scientificName": "æ‹‰ä¸å­¸å", '
            + '"plantType": "éç¶­ç®¡æ¤ç‰©ã€ç¶­ç®¡æ¤ç‰©ã€ç„¡ç¨®å­æ¤ç‰©ã€è£¸å­æ¤ç‰©ã€è•¨é¡æ¤ç‰©ã€å–®å­è‘‰æ¤ç‰©ã€é›™å­è‘‰æ¤ç‰©ã€æœ‰èŠ±æ¤ç‰©ã€ç„¡èŠ±æ¤ç‰© ä¹‹ä¸€", '
            + '"funFact": "ç°¡çŸ­æœ‰è¶£çŸ¥è­˜ï¼ˆ30å­—å·¦å³ï¼‰" }\n\n'
            + 'è‹¥ä¸æ˜¯æ¤ç‰©ï¼Œå›å‚³ï¼š\n'
            + '{ "isPlant": false, "matchesCategory": false, "plantName": "", "scientificName": "", "plantType": "", "funFact": "" }';

        const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64Data } }] }],
            generationConfig: { responseMimeType: "application/json" }
        };

        try {
            const response = await fetch(getWorkerUrl(), {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            if (!response.ok) throw new Error('API request failed: ' + response.status);
            const result = await response.json();
            const data = JSON.parse(result.candidates[0].content.parts[0].text);

            if (!data.isPlant) {
                competitionIsProcessing = false;
                showModal('<div class="text-6xl mb-4">ğŸ¤”</div><h3 class="text-2xl font-bold mb-2">é€™ä¸æ˜¯æ¤ç‰©å–”</h3><p class="text-gray-600 mb-6">è«‹æ‰¾ä¸€ç¨®æ¤ç‰©ä¾†æ‹æ”ï¼</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">ç¹¼çºŒ</button>', () => {
                    showCompetitionActiveScreen(); startCompetitionTimer();
                });
                return;
            }

            // Store result and advance
            if (data.matchesCategory) {
                session.results[targetCategory] = { status: 'correct', plantName: data.plantName, scientificName: data.scientificName, funFact: data.funFact };
                gameState.competition.monthlyScore++;
                gameState.competition.monthlyCorrect++;
                if (data.plantName && !gameState.competition.monthlyPlantsFound.includes(data.plantName)) {
                    gameState.competition.monthlyPlantsFound.push(data.plantName);
                }
            } else {
                session.results[targetCategory] = { status: 'incorrect', plantName: data.plantName || '', funFact: data.funFact || '' };
                gameState.competition.monthlyWrong++;
            }
            session.currentIndex++;
            saveGameState();

            const correct = Object.values(session.results).filter(r => r.status === 'correct').length;
            const icon = data.matchesCategory ? 'âœ…' : 'âŒ';
            const title = data.matchesCategory ? 'æ­£ç¢ºï¼' : 'ç­”éŒ¯äº†';
            const color = data.matchesCategory ? 'emerald' : 'red';
            const afterModalFn = () => {
                if (session.currentIndex >= session.types.length) {
                    endCompetitionSession(false);
                } else {
                    showCompetitionActiveScreen(); startCompetitionTimer();
                }
            };
            showModal(
                '<div class="text-6xl mb-4">' + icon + '</div>'
                + '<h3 class="text-2xl font-bold mb-2 text-' + color + '-700">' + title + '</h3>'
                + (data.plantName ? '<p class="text-sm text-gray-600 mt-2">' + data.plantName + '</p>' : '')
                + (data.funFact ? '<p class="text-xs text-gray-400 mt-1">' + data.funFact + '</p>' : '')
                + '<p class="text-lg font-bold text-gray-700 mt-3">ç›®å‰æ­£ç¢ºï¼š' + correct + ' / ' + session.types.length + '</p>'
                + '<button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full mt-4">' + (session.currentIndex >= session.types.length ? 'æŸ¥çœ‹çµæœ' : 'ä¸‹ä¸€é¡Œ') + '</button>',
                afterModalFn
            );
        } catch (error) {
            console.error("Competition API error:", error);
            showModal('<div class="text-6xl mb-4">ğŸ˜¢</div><h3 class="text-2xl font-bold mb-2">åˆ†æå¤±æ•—</h3><p class="text-gray-600 mb-6">ç„¡æ³•è¾¨è­˜åœ–ç‰‡ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">ç¹¼çºŒ</button>', () => {
                showCompetitionActiveScreen(); startCompetitionTimer();
            });
        } finally {
            competitionIsProcessing = false;
        }
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        // Assign DOM elements
        navButtons = { home: document.getElementById('nav-home'), challenge: document.getElementById('nav-challenge'), tasks: document.getElementById('nav-tasks'), pokedex: document.getElementById('nav-pokedex'), shop: document.getElementById('nav-shop'), competition: document.getElementById('nav-competition') };
        screens = { start: document.getElementById('start-screen'), home: document.getElementById('home-screen'), loading: document.getElementById('loading-screen'), result: document.getElementById('result-screen'), tasks: document.getElementById('tasks-screen'), achievements: document.getElementById('achievements-screen'), pokedex: document.getElementById('pokedex-screen'), shop: document.getElementById('shop-screen'), challenge: document.getElementById('challenge-screen'), camera: document.getElementById('camera-screen'), competition: document.getElementById('competition-screen'), competitionActive: document.getElementById('competition-active-screen'), competitionCamera: document.getElementById('competition-camera-screen') };
        petVisual = document.getElementById('pet-visual'); petName = document.getElementById('pet-name'); levelText = document.getElementById('level-text'); xpBar = document.getElementById('xp-bar'); xpValue = document.getElementById('xp-value'); seedCountText = document.getElementById('seed-count'); plantInput = document.getElementById('plant-input'); modal = document.getElementById('modal'); petDecoration = document.getElementById('pet-decoration');
        mainNav = document.getElementById('main-nav'); cameraFeed = document.getElementById('camera-feed'); captureBtn = document.getElementById('capture-btn'); cancelCameraBtn = document.getElementById('cancel-camera-btn'); canvas = document.getElementById('canvas');
        
        // Add Event Listeners
        plantInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                hideModal();
                const reader = new FileReader();
                reader.onload = (re) => processImage(re.target.result.split(',')[1], re.target.result);
                reader.readAsDataURL(file);
            }
        });
        document.getElementById('settings-btn').addEventListener('click', showSettingsModal);
        document.getElementById('achievements-btn').addEventListener('click', () => { navigateTo('achievements'); renderAchievements(); });
        Object.keys(navButtons).forEach(key => { if (navButtons[key]) navButtons[key].addEventListener('click', () => navigateTo(key)); });
        captureBtn.addEventListener('click', capturePhoto);
        cancelCameraBtn.addEventListener('click', () => { stopCamera(); navigateTo('challenge'); });
        document.getElementById('competition-capture-btn').addEventListener('click', competitionCapturePhoto);
        document.getElementById('competition-cancel-camera-btn').addEventListener('click', () => { stopCamera(); showCompetitionActiveScreen(); startCompetitionTimer(); });
        
        // Initial setup
        if (loadGameState()) {
            mainNav.classList.remove('hidden');
            checkDailyTasks();
            checkMonthlyCompetitionReset();
            renderAll();
            // Check for active/expired competition session
            if (gameState.competition.session) {
                if (Date.now() < gameState.competition.session.endTime) {
                    navigateTo('home');
                    showCompetitionActiveScreen();
                    startCompetitionTimer();
                } else {
                    endCompetitionSession(false);
                }
            } else {
                navigateTo('home');
            }
        } else {
            screens.start.classList.remove('hidden');
            const petChoice1 = document.getElementById('pet-choice-1');
            const petChoice2 = document.getElementById('pet-choice-2');
            const startPetName = document.getElementById('start-pet-name');
            const startGameBtn = document.getElementById('start-game-btn');
            
            let selectedPetURL = petChoice1.dataset.visual;
            let selectedPetName = petChoice1.dataset.name;
            let selectedPetType = petChoice1.dataset.type;
            petChoice1.classList.add('selected');
            startPetName.value = selectedPetName;

            petChoice1.addEventListener('click', () => {
                selectedPetURL = petChoice1.dataset.visual;
                selectedPetName = petChoice1.dataset.name;
                selectedPetType = petChoice1.dataset.type;
                petChoice1.classList.add('selected');
                petChoice2.classList.remove('selected');
                startPetName.value = selectedPetName;
            });
            petChoice2.addEventListener('click', () => {
                selectedPetURL = petChoice2.dataset.visual;
                selectedPetName = petChoice2.dataset.name;
                selectedPetType = petChoice2.dataset.type;
                petChoice2.classList.add('selected');
                petChoice1.classList.remove('selected');
                startPetName.value = selectedPetName;
            });
            
            startGameBtn.addEventListener('click', () => {
                const petNameValue = startPetName.value.trim();
                if (!petNameValue) {
                    showModal(`<div class="text-6xl mb-4">âš ï¸</div><h3 class="text-2xl font-bold mb-2">æç¤º</h3><p class="text-gray-600 mb-6">è«‹ç‚ºæ‚¨çš„å¯µç‰©å–ä¸€å€‹åå­—ï¼</p><button class="modal-close-btn btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full">å¥½çš„</button>`);
                    return;
                }
                initializeGame(petNameValue, selectedPetURL, selectedPetType);
            });
        }
    });
</script>

</body>
</html>
